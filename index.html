<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        /* Modal styles for README popup */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            height: 90%;
            overflow-y: auto;
            border-radius: 5px;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .readme-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin-top: 20px;
        }
        .readme-content h1 { color: #2c3e50; }
        .readme-content h2 { color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .readme-content h3 { color: #7f8c8d; }
        .readme-content code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
        .readme-content pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }

        /* Button organization styles */
        .button-section {
            border: 2px solid #3498db;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .button-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-family: Arial, sans-serif;
            font-size: 16px;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 5px;
        }
        .utility-buttons {
            margin-top: 20px;
        }
        .utility-buttons button {
            margin: 5px;
        }

        /* Collapsible Phase Sections */
        .phase-section {
            border: 2px solid #2980b9;
            border-radius: 8px;
            margin: 15px 0;
            background-color: #fff;
            overflow: hidden;
        }
        .phase-section.phase-a {
            border-color: #e74c3c;
        }
        .phase-section.phase-b {
            border-color: #27ae60;
        }
        .phase-section.extra-tools {
            border-color: #7f8c8d;
        }
        .phase-section.db-maintenance {
            border-color: #00897b;
        }
        .phase-section.entity-browsers {
            border-color: #7b1fa2;
        }
        .phase-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        .phase-section.phase-a .phase-header {
            background-color: #fadbd8;
        }
        .phase-section.phase-b .phase-header {
            background-color: #d5f5e3;
        }
        .phase-section.extra-tools .phase-header {
            background-color: #ebedef;
        }
        .phase-section.db-maintenance .phase-header {
            background-color: #e0f2f1;
        }
        .phase-section.entity-browsers .phase-header {
            background-color: #f3e5f5;
        }
        .phase-header:hover {
            filter: brightness(0.95);
        }
        .phase-toggle {
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s ease;
        }
        .phase-section.collapsed .phase-toggle {
            transform: rotate(-90deg);
        }
        .phase-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        .phase-subtitle {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: auto;
        }
        .phase-content {
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        .phase-section.collapsed .phase-content {
            display: none;
        }

        /* Step styling within phases */
        .step-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 12px;
        }
        .step-box:last-child {
            margin-bottom: 0;
        }
        .step-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .step-description {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .step-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .step-buttons button {
            margin: 0;
        }
        .step-arrow {
            color: #adb5bd;
            font-weight: bold;
        }
        .step-note {
            font-size: 11px;
            color: #868e96;
            font-style: italic;
            margin-left: 8px;
        }

        /* Entity Browser Styles */
        .entity-browser-section {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            padding: 20px;
        }

        .entity-browser-section h3 {
            color: #007bff;
            margin-top: 0;
        }

        .collection-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .collection-tab {
            padding: 10px 20px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .collection-tab.active {
            background-color: #007bff;
            color: white;
        }

        .search-section {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .search-input {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-button {
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .search-button:hover {
            background-color: #218838;
        }

        .quick-filters {
            margin-top: 10px;
        }

        .filter-button {
            padding: 5px 10px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }

        .filter-button:hover {
            background-color: #5a6268;
        }

        .results-section {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .results-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }

        .results-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .result-item:hover {
            background-color: #f8f9fa;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .entity-key {
            font-family: 'Courier New', monospace;
            color: #6c757d;
            font-size: 12px;
        }

        .entity-name {
            font-weight: bold;
            color: #333;
        }

        .entity-details {
            color: #666;
            font-size: 14px;
        }

        .action-buttons {
            margin-top: 15px;
        }

        .action-button {
            padding: 8px 16px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .action-button:hover {
            background-color: #138496;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .status-loading {
            background-color: #cce5ff;
            border: 1px solid #007bff;
            color: #004085;
        }

        .status-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        /* Unified Entity Browser Styles */
        .unified-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .unified-result-item:hover {
            background-color: #f8f9fa;
        }

        .unified-result-item.unified-selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .unified-result-item:last-child {
            border-bottom: none;
        }

        .unified-entity-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .unified-source-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .unified-source-visionappraisal {
            background-color: #dc3545;
        }

        .unified-source-bloomerang {
            background-color: #007bff;
        }

        .unified-entity-type {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .unified-entity-key {
            font-family: 'Courier New', monospace;
            color: #6c757d;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .unified-entity-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .unified-entity-details {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }

        .unified-status-message {
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .unified-status-loading {
            background-color: #cce5ff;
            border: 1px solid #007bff;
            color: #004085;
        }

        .unified-status-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .unified-status-success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .control-section {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .control-group label {
            font-size: 13px;
        }

        .control-group select {
            background-color: white;
            transition: border-color 0.2s ease;
        }

        .control-group select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        /* Responsive adjustments for unified browser */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 15px !important;
            }

            .control-group {
                min-width: auto !important;
            }

            .unified-entity-header {
                flex-wrap: wrap;
            }
        }

        /* EntityGroup Browser Styles */
        .entitygroup-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .entitygroup-result-item:hover {
            background-color: #f3e5f5;
        }

        .entitygroup-result-item.entitygroup-selected {
            background-color: #e1bee7;
            border-left: 4px solid #9c27b0;
        }

        .entitygroup-result-item:last-child {
            border-bottom: none;
        }

        .entitygroup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .entitygroup-index {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            background-color: #9c27b0;
        }

        .entitygroup-member-count {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .entitygroup-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .entitygroup-badge-prospect {
            background-color: #4caf50;
            color: white;
        }

        .entitygroup-badge-donor {
            background-color: #2196f3;
            color: white;
        }

        .entitygroup-badge-nearmiss {
            background-color: #ff9800;
            color: white;
        }

        .entitygroup-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .entitygroup-details {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }

        .entitygroup-members-preview {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }

        /* Street Name Browser Styles */
        .streetname-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .streetname-result-item:hover {
            background-color: #e0f2f1;
        }

        .streetname-result-item.streetname-selected {
            background-color: #b2dfdb;
            border-left: 4px solid #00897b;
        }

        .streetname-result-item:last-child {
            border-bottom: none;
        }

        .streetname-primary {
            font-weight: bold;
            color: #00695c;
            font-size: 14px;
        }

        .streetname-alias-count {
            font-size: 11px;
            color: #666;
            margin-left: 10px;
        }

        .streetname-alias-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 5px;
        }

        .streetname-alias-homonym {
            background-color: #c8e6c9;
            color: #2e7d32;
        }

        .streetname-alias-synonym {
            background-color: #fff9c4;
            color: #f57f17;
        }

        .streetname-alias-candidate {
            background-color: #e1bee7;
            color: #7b1fa2;
        }

        /* Individual Name Browser Styles */
        .individualname-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .individualname-result-item:hover {
            background-color: #e3f2fd;
        }
        .individualname-selected {
            background-color: #bbdefb !important;
            border-left: 3px solid #1565c0;
        }
        .individualname-primary {
            font-weight: 600;
            color: #1565c0;
        }
        .individualname-components {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .individualname-alias-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 5px;
        }
        .individualname-alias-homonym {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .individualname-alias-synonym {
            background-color: #fff9c4;
            color: #f57f17;
        }
        .individualname-alias-candidate {
            background-color: #e1bee7;
            color: #7b1fa2;
        }
        .individualname-alias-count {
            font-size: 11px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="googleAuth">
        <button id="authorize_button" class="authBut myButts" onclick="handleAuthClick()">Authorize</button>
        <button id="signout_button" class="authBut myButts" onclick="handleSignoutClick()">Sign Out</button>
    </div>
    <div id="holder">
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- PHASE A: Rebuild from Source Data                                           -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="phase-section phase-a collapsed" id="phaseA">
            <div class="phase-header" onclick="togglePhase('phaseA')">
                <span class="phase-toggle">‚ñº</span>
                <span class="phase-title">PHASE A: Rebuild from Source Data</span>
                <span class="phase-subtitle">Run when VisionAppraisal or Bloomerang source data has changed</span>
            </div>
            <div class="phase-content">
                <!-- Step A0: Prepare PID List -->
                <div class="step-box">
                    <div class="step-label">Step A0: Prepare PID List from VisionAppraisal Website</div>
                    <div class="step-description">Scrapes the VisionAppraisal website to build a list of all property IDs (PIDs). Run these three buttons in sequence.</div>
                    <div class="step-buttons">
                        <button id="firstButton" class="optBut" onclick="firstButterClick()">First Button</button>
                        <span class="step-arrow">‚Üí</span>
                        <button id="secondButton" class="optBut" onclick="secondButterClick()">Second Button</button>
                        <span class="step-arrow">‚Üí</span>
                        <button id="thirdButton" class="optBut" onclick="thirdButterClick()">Third Button</button>
                    </div>
                </div>

                <!-- Step A1: Download PIDs -->
                <div class="step-box">
                    <div class="step-label">Step A1: Download PID Details from VisionAppraisal Website</div>
                    <div class="step-description">Downloads detailed property data for each PID. This process may fail for some PIDs due to network issues - use "Go Again" to retry failed downloads.</div>
                    <div class="step-buttons">
                        <button id="fourthButton" class="optBut" onclick="fourthButterClick()">Fourth Button</button>
                        <button id="Go Again" class="optBut" onclick="goAgain()" style="background-color: #f39c12; color: white;">Go Again</button>
                        <span class="step-note">‚Üê retry failed downloads</span>
                    </div>
                </div>

                <!-- Step A2: Clean Up Duplicates -->
                <div class="step-box">
                    <div class="step-label">Step A2: Clean Up PID Duplicates</div>
                    <div class="step-description">Analyzes and removes duplicate PID files from previous runs. "Analyze" is safe (read-only), "Deduplication" moves older duplicates.</div>
                    <div class="step-buttons">
                        <button id="analyzePids" class="optBut" onclick="analyzePIDFolder()" style="background-color: #6c757d; color: white;">Analyze PID Duplicates</button>
                        <button id="cleanupPids" class="optBut" onclick="runPIDDeduplication()" style="background-color: #dc3545; color: white;">Run PID Deduplication</button>
                    </div>
                </div>

                <!-- Step A3: Consolidate PID Files -->
                <div class="step-box">
                    <div class="step-label">Step A3: Consolidate PID Files to Local Storage</div>
                    <div class="step-description">Combines all PID files from Google Drive into one local file (<code>everyThingWithPid.json</code>). Run this after downloading new PIDs to update local data with latest assessment/appraisal values.</div>
                    <div class="step-buttons">
                        <button class="optBut" onclick="generateFreshEveryThingWithPid()" id="refreshPidDataBtn" style="background-color: #17a2b8; color: white;">
                            üì• Refresh Local PID Data from Google Drive
                        </button>
                    </div>
                </div>

                <!-- Step A4: Process VA Data and Create Entities -->
                <div class="step-box">
                    <div class="step-label">Step A4: Process VisionAppraisal Data and Create Entities</div>
                    <div class="step-description">Two-part process: (a) Clean names, parse addresses, extract MBLU fields. (b) Create entity objects (Individual, Household, Business, LegalConstruct).</div>
                    <div class="step-buttons" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px; font-weight: 600; color: #495057;">(a)</span>
                            <button class="optBut" onclick="processAndSaveVisionAppraisal()" id="visionProcessBtn">
                                üîÑ Process & Save VisionAppraisal Data
                            </button>
                            <span class="step-note">Cleans and saves processed records</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px; font-weight: 600; color: #495057;">(b)</span>
                            <button class="optBut" onclick="runEntityProcessing()" id="entityProcessBtn">
                                üèóÔ∏è Create Entities from Processed Data
                            </button>
                            <span class="step-note">Creates entity objects from processed data</span>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 5px; padding-left: 20px;">
                            <label style="font-size: 11px; color: #666;">
                                Detailed Results:
                                <select id="showDetailedResults" style="padding: 2px 5px; font-size: 11px;">
                                    <option value="false">Off</option>
                                    <option value="true">On</option>
                                </select>
                            </label>
                            <label style="font-size: 11px; color: #666;">
                                Quiet Mode:
                                <select id="quietMode" style="padding: 2px 5px; font-size: 11px;">
                                    <option value="true">On</option>
                                    <option value="false">Off</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step A5: Process Bloomerang -->
                <div class="step-box">
                    <div class="step-label">Step A5: Process Bloomerang Data</div>
                    <div class="step-description">First export "all data.csv" from the Bloomerang application, then click to process. Creates Individual and AggregateHousehold entities with household information.</div>
                    <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 8px; margin: 8px 0; font-size: 11px; font-weight: bold;">
                        PREPROCESSING: 1) GET RID OF TOTAL ROW 2) REPLACE \n WITH SPACE 3) CHANGE COMMAS IN ADDRESS COLUMNS TO ^#C#^
                    </div>
                    <div class="step-buttons">
                        <button class="optBut" onclick="readBloomerangWithEntities(true)">Process Bloomerang CSV</button>
                    </div>
                </div>

                <!-- Step A6: Build and Save Unified Database -->
                <div class="step-box">
                    <div class="step-label">Step A6: Build and Save Unified Database</div>
                    <div class="step-description">Combines VisionAppraisal and Bloomerang entities into a unified keyed database. Save to Google Drive for future use.</div>
                    <div style="margin-bottom: 10px;">
                        <label for="bloomerangConfigFileId" style="display: block; font-size: 11px; color: #666; margin-bottom: 3px;">
                            Bloomerang Config File ID (contains current entity file IDs):
                        </label>
                        <input type="text"
                               id="bloomerangConfigFileId"
                               placeholder="Enter Google Drive file ID"
                               style="width: 100%; max-width: 400px; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px;"
                               onchange="saveBloomerangConfigFileId(this.value)">
                    </div>
                    <div class="step-buttons" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="loadAllEntitiesIntoMemory()" style="background-color: #28a745; color: white;">
                                üöÄ Load All Entities Into Memory
                            </button>
                            <span class="step-note">Builds unified database from source files</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="recordUnifiedDatabase()" style="background-color: #3498db; color: white;" id="recordUnifiedBtn">
                                üíæ Record Unified Database
                            </button>
                            <span class="step-note">Saves to Google Drive for future use</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label for="unifiedDatabaseFileId" style="display: block; font-size: 11px; color: #666; margin-bottom: 3px;">
                            Unified Database File ID (for persistence):
                        </label>
                        <input type="text"
                               id="unifiedDatabaseFileId"
                               placeholder="Enter Google Drive file ID for unified database"
                               style="width: 100%; max-width: 400px; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px;"
                               onchange="saveUnifiedDatabaseFileId(this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- PHASE B: Work with Saved Data                                               -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="phase-section phase-b collapsed" id="phaseB">
            <div class="phase-header" onclick="togglePhase('phaseB')">
                <span class="phase-toggle">‚ñº</span>
                <span class="phase-title">PHASE B: Work with Saved Data</span>
                <span class="phase-subtitle">Skip Phase A if source data hasn't changed</span>
            </div>
            <div class="phase-content">
                <!-- Step B1: Load Unified Database -->
                <div class="step-box">
                    <div class="step-label">Step B1: Load Unified Database from Google Drive</div>
                    <div class="step-description">Loads a previously saved unified entity database. Use this to skip Phase A when source data hasn't changed.</div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 11px; color: #666; margin-bottom: 3px;">
                            Unified Database File ID:
                        </label>
                        <input type="text"
                               id="unifiedDatabaseFileIdB"
                               placeholder="Enter Google Drive file ID for unified database"
                               style="width: 100%; max-width: 400px; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px;"
                               onchange="saveUnifiedDatabaseFileId(this.value); document.getElementById('unifiedDatabaseFileId').value = this.value;">
                    </div>
                    <div class="step-buttons">
                        <button class="optBut" onclick="loadUnifiedDatabaseFromDrive()" style="background-color: #e67e22; color: white;" id="loadUnifiedBtn">
                            üìÇ Load Unified Database
                        </button>
                    </div>
                </div>

                <!-- Step B2: EntityGroups -->
                <div class="step-box">
                    <div class="step-label">Step B2: Build or Load EntityGroups</div>
                    <div class="step-description">Use the EntityGroup Browser section below to build new groups from the unified database, or load previously saved groups.</div>
                    <div style="font-size: 12px; color: #495057; padding: 8px; background-color: #e8f4fd; border-radius: 4px;">
                        ‚Üì See <strong>EntityGroup Browser</strong> section below
                    </div>
                </div>

                <!-- Step B3: Reports -->
                <div class="step-box">
                    <div class="step-label">Step B3: Generate Reports</div>
                    <div class="step-description">Export CSV reports, assessment value reports, and lightweight JSON for Google Apps Script.</div>
                    <div style="font-size: 12px; color: #495057; padding: 8px; background-color: #e8f4fd; border-radius: 4px;">
                        ‚Üì See <strong>CSV Reports</strong> panel in EntityGroup Browser below
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- EXTRA TOOLS (collapsed by default)                                          -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="phase-section extra-tools collapsed" id="extraTools">
            <div class="phase-header" onclick="togglePhase('extraTools')">
                <span class="phase-toggle">‚ñº</span>
                <span class="phase-title">üîß Extra Tools</span>
                <span class="phase-subtitle">Advanced operations, shortcuts, and development utilities</span>
            </div>
            <div class="phase-content">
                <!-- Shortcuts -->
                <div class="step-box">
                    <div class="step-label">Shortcuts</div>
                    <div class="step-description">Convenience buttons that combine multiple steps.</div>
                    <div class="step-buttons">
                        <button id="firstTwo" class="optBut" onclick="firstTwoClick()">First Two</button>
                        <button id="firstThree" class="optBut" onclick="firstThreeClick()">First Three</button>
                        <button id="AllButton" class="optBut" onclick="AllClick()">All Button</button>
                        <button id="MandGo" class="optBut" onclick="mergeTheTwo()">Merge and Go Again</button>
                    </div>
                </div>

                <!-- Database Operations -->
                <div class="step-box">
                    <div class="step-label">Database Operations</div>
                    <div class="step-description">Advanced database manipulation tools.</div>
                    <div class="step-buttons" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="loadAndRecordEntities()" style="background-color: #9b59b6; color: white;" id="loadAndRecordBtn">
                                üì• Load & Record Entities
                            </button>
                            <span class="step-note">Loads from source AND saves unified database</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="splitDatabaseForAppsScript()" style="background-color: #27ae60; color: white;" id="splitDbBtn">
                                ‚úÇÔ∏è Split Database for Apps Script
                            </button>
                            <span class="step-note">Creates 3 files under 50MB each</span>
                        </div>
                    </div>
                </div>

                <!-- Entity Analysis -->
                <div class="step-box">
                    <div class="step-label">Entity Analysis</div>
                    <div class="step-description">Run comparisons on all entities and generate analysis reports. Requires entities loaded first.</div>
                    <div class="step-buttons" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="runFullEntityAnalysisWithCSV()" style="background-color: #8e44ad; color: white;" id="analyzeAllEntitiesBtn">
                                üìä Analyze All Entities & Download CSV
                            </button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="runChunkedEntityAnalysis()" style="background-color: #16a085; color: white;" id="analyzeChunkedBtn">
                                üì¶ Chunked Analysis (Memory-Safe)
                            </button>
                            <span class="step-note">Downloads in 200-entity batches</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="runGoogleDriveAnalysis()" style="background-color: #e74c3c; color: white;" id="analyzeGoogleDriveBtn">
                                ‚òÅÔ∏è Analyze to Google Drive
                            </button>
                            <span class="step-note">Most memory-efficient</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="optBut" onclick="analyzeBloomerangCSV()">Analyze CSV Quality</button>
                            <span class="step-note">Bloomerang CSV analysis</span>
                        </div>
                    </div>
                </div>

                <!-- Development Tools -->
                <div class="step-box">
                    <div class="step-label">Development Tools</div>
                    <div class="step-description">Utilities for development and testing.</div>
                    <div class="step-buttons">
                        <button id="oneToONe" class="optBut" onclick="makeOneToOneFile()">Make One To One File</button>
                        <button id="test" class="optBut" onclick="test()">Test</button>
                        <button class="optBut" onclick="readPhonebook()">Process Phonebook Data</button>
                        <button class="optBut" onclick="processPhonebookFile()" style="background-color: #6f42c1;">Parse Phonebook File</button>
                        <button id="readmeButton" class="optBut" onclick="showReadme()">üìñ README</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- ENTITY BROWSERS: Unified Entity and EntityGroup Browsers                   -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="phase-section entity-browsers collapsed" id="entityBrowsers">
            <div class="phase-header" onclick="togglePhase('entityBrowsers')">
                <span class="phase-toggle">‚ñº</span>
                <span class="phase-title">ENTITY BROWSERS: Unified Entity and EntityGroup Browsers</span>
                <span class="phase-subtitle">Browse entities and matched groups</span>
            </div>
            <div class="phase-content">

                <!-- Unified Entity Browser Section -->
                <div class="entity-browser-section" style="border-color: #28a745;">
                    <h3 style="color: #28a745;">üåê Unified Entity Browser - Multi-Source Data Explorer</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                <div class="control-row" style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="unifiedDataSourceSelector" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Data Source:</label>
                        <select id="unifiedDataSourceSelector" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="all">üåê All Data Sources</option>
                            <option value="visionappraisal">üè† VisionAppraisal Property Data</option>
                            <option value="bloomerang">üë• Bloomerang Contact Database</option>
                        </select>
                    </div>

                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="unifiedEntityTypeSelector" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Entity Type:</label>
                        <select id="unifiedEntityTypeSelector" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="all">All Types</option>
                            <option value="Individual">Individual</option>
                            <option value="AggregateHousehold">Aggregate Household</option>
                            <option value="Business">Business</option>
                            <option value="LegalConstruct">Legal Construct</option>
                            <option value="NonHuman">Non-Human</option>
                        </select>
                    </div>

                    <div class="control-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button id="unifiedLoadDataBtn" class="action-button" style="background-color: #28a745; padding: 10px 20px; font-weight: 600;">
                            üìÅ Load All Data Sources
                        </button>
                        <button id="unifiedRefreshDisplayBtn" class="action-button" style="background-color: #17a2b8; padding: 10px 20px; font-weight: 600;" onclick="refreshUnifiedBrowserDisplay()">
                            üîÑ Refresh Display
                        </button>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>Multi-Source Browser:</strong> Select a specific data source or choose "All Data Sources" to browse entities from VisionAppraisal and Bloomerang simultaneously.
                    The browser will automatically adapt the display and filters based on your selection.
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="unifiedSearchInput" class="search-input" placeholder="Search across all fields: names, account numbers, fire numbers, addresses, emails..." onkeypress="handleUnifiedSearchKeyPress(event)">
                <button id="unifiedSearchBtn" class="search-button" onclick="performUnifiedSearch()">üîç Search</button>
                <button id="unifiedClearBtn" class="search-button" onclick="clearSearchAndFilters()" style="background-color: #6c757d;">Clear</button>

                <div class="quick-filters">
                    <strong>Enhanced Quick Filters:</strong>
                    <button class="filter-button" onclick="applyQuickFilter('account')">By Account #</button>
                    <button class="filter-button" onclick="applyQuickFilter('fire')">By Fire #</button>
                    <button class="filter-button" onclick="applyQuickFilter('pid')">By PID</button>
                    <button class="filter-button" onclick="applyQuickFilter('name')">By Name</button>
                    <button class="filter-button" onclick="applyQuickFilter('all')" style="background-color: #17a2b8;">Show All</button>
                </div>
            </div>

            <div id="unifiedStatusMessage" class="status-message" style="display: none;"></div>

            <div class="results-section">
                <div class="results-header">
                    <span id="unifiedResultsCount">Select data source and click Load to begin</span>
                </div>
                <div id="unifiedResultsList" class="results-list">
                    <div style="padding: 20px; text-align: center; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üåê</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Unified Entity Browser</div>
                        <div>Select data source and load data to begin browsing entities</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="unifiedViewDetailsBtn" class="action-button">üëÅÔ∏è View Details</button>
                <button id="unifiedAnalyzeMatchesBtn" class="action-button" style="background-color: #8e44ad;">üîç Analyze Matches</button>
                <button id="unifiedExportBtn" class="action-button" onclick="exportCurrentResults()">üìÑ Export Results</button>
                <button id="unifiedStatsBtn" class="action-button" onclick="showUnifiedStats()">üìä Unified Stats</button>
                <button class="action-button" onclick="clearSearchAndFilters()" style="background-color: #6c757d;">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <!-- EntityGroup Browser Section -->
        <div class="entity-browser-section" style="border-color: #9c27b0;">
            <h3 style="color: #9c27b0;">üìä EntityGroup Browser - Matched Entity Groups Explorer</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                <!-- File ID inputs row -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 320px;">
                        <label for="entityGroupFileId" style="font-weight: 600; margin-bottom: 5px; color: #495057;">EntityGroup Database File ID:</label>
                        <input type="text" id="entityGroupFileId" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; font-family: 'Courier New', monospace;" placeholder="Enter database file ID...">
                    </div>
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 320px;">
                        <label for="entityGroupReferenceFileId" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Reference File ID:</label>
                        <input type="text" id="entityGroupReferenceFileId" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; font-family: 'Courier New', monospace;" placeholder="Enter reference file ID...">
                    </div>
                </div>

                <!-- Load/Build/Save buttons row -->
                <div class="control-row" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <button id="entityGroupLoadBtn" class="action-button" style="background-color: #9c27b0; padding: 10px 20px; font-weight: 600;">
                        üìÇ Load EntityGroups
                    </button>
                    <button id="entityGroupBuildBtn" class="action-button" style="background-color: #ff9800; padding: 10px 20px; font-weight: 600;">
                        üî® Build New
                    </button>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: #495057; cursor: pointer;">
                        <input type="checkbox" id="loadOverrideRulesCheckbox" checked style="cursor: pointer;">
                        Load override rules
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: #495057;" title="Leave blank for full build. Enter a number (e.g., 200) for faster test builds.">
                        <span>Sample size:</span>
                        <input type="number" id="entityGroupSampleSize" min="10" max="4000" placeholder="(full)"
                               style="width: 70px; padding: 4px 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                    </label>
                    <span style="color: #999; margin: 0 5px;">|</span>
                    <button id="entityGroupSaveToFileIdBtn" class="action-button" style="background-color: #17a2b8; padding: 10px 16px; font-weight: 600;">
                        üíæ Save to File IDs
                    </button>
                    <button id="entityGroupSaveAsNewBtn" class="action-button" style="background-color: #28a745; padding: 10px 16px; font-weight: 600;">
                        üìÑ Save as New Files
                    </button>
                </div>

                <div class="control-row" style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="entityGroupFilter" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Filter Groups:</label>
                        <select id="entityGroupFilter" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="all">All Groups</option>
                            <option value="multi">Multi-Member Only</option>
                            <option value="single">Single-Member Only</option>
                            <option value="prospects">Prospects (No Bloomerang)</option>
                            <option value="donors">Existing Donors (Has Bloomerang)</option>
                            <option value="nearMisses">Groups with Near Misses</option>
                        </select>
                    </div>
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="entityGroupSort" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Sort By:</label>
                        <select id="entityGroupSort" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="index">Group Index</option>
                            <option value="memberCount">Member Count (Desc)</option>
                            <option value="name">Consensus Name</option>
                        </select>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>EntityGroup Browser:</strong> Browse matched entity groups that consolidate entities from multiple data sources into unified real-world person/household representations.
                    Load a saved EntityGroup database from Google Drive or build a new one from the Unified Entity Database.
                </div>

                <!-- Load Unified Database button - Required to display entity names/addresses in the browser -->
                <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <button id="entityGroupLoadUnifiedDbBtn" class="action-button" style="background-color: #28a745; padding: 8px 16px; font-weight: 600;">
                            üìÇ Load Unified Database
                        </button>
                        <span style="font-size: 12px; color: #856404;">
                            <strong>Required:</strong> Load the Unified Entity Database to display founding member names and addresses.
                            Uses the file ID from "Entity Reconstruction" section above. Without this, groups will show "entity (not loaded)".
                        </span>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="entityGroupSearchInput" class="search-input" placeholder="Search groups by name, address, or member details...">
                <button id="entityGroupSearchBtn" class="search-button">üîç Search</button>
                <button id="entityGroupClearBtn" class="search-button" style="background-color: #6c757d;">Clear</button>
            </div>

            <div id="entityGroupStatusMessage" class="status-message" style="display: none;"></div>

            <div class="results-section">
                <div class="results-header">
                    <span id="entityGroupResultsCount">Enter file ID and click Load to browse EntityGroups</span>
                </div>
                <div id="entityGroupResultsList" class="results-list">
                    <div style="padding: 20px; text-align: center; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">EntityGroup Browser</div>
                        <div>Enter a Google Drive file ID and load to begin browsing entity groups</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="entityGroupViewDetailsBtn" class="action-button">üëÅÔ∏è View Group Details</button>
                <button id="entityGroupExportBtn" class="action-button">üìÑ Export Groups</button>
                <button id="entityGroupStatsBtn" class="action-button">üìä Group Stats</button>
            </div>
        </div>

        <!-- Individual and AggregateHousehold Creation Section -->
        <div class="entity-browser-section" style="border-color: #e91e63;">
            <h3 style="color: #e91e63;">üë• Individual and AggregateHousehold Creation</h3>
            <div style="padding: 12px; background: #fce4ec; border: 1px solid #f8bbd9; border-radius: 6px;">
                <button id="entityGroupRebuildConsensusBtn" class="action-button"
                        style="background-color: #e91e63; padding: 10px 16px; font-weight: 600;">
                    üîÑ Rebuild Consensus
                </button>
                <div style="font-size: 11px; color: #880e4f; margin-top: 8px;">
                    Rebuild consensus entities for all multi-member groups using the current algorithm.
                    Requires EntityGroup database and Unified Entity Database to be loaded. Save to preserve changes.
                </div>
            </div>
        </div>

            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- TOOLS: CSV Reports, Entity Comparison, Override Rules Audit                 -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="phase-section tools collapsed" id="toolsSection">
            <div class="phase-header" onclick="togglePhase('toolsSection')">
                <span class="phase-toggle">‚ñº</span>
                <span class="phase-title">TOOLS: Reports and Diagnostics</span>
                <span class="phase-subtitle">CSV exports, entity comparison, override audits</span>
            </div>
            <div class="phase-content">

        <div class="entity-browser-section" style="border-color: #607d8b;">
            <h3 style="color: #607d8b;">üõ†Ô∏è Tools</h3>

            <!-- CSV Reports Panel -->
            <div style="padding: 12px; background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 6px; margin-bottom: 15px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #2e7d32;">üì• CSV Reports</div>

                <!-- Prospects + Donors Export -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="downloadCSVExport()" style="padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; margin-right: 10px;">
                        üì• Prospects + Donors
                    </button>
                    <label style="display: inline-flex; align-items: center; font-size: 12px;">
                        <input type="checkbox" id="csvIncludeNearMisses" checked style="margin-right: 5px;">
                        Include Near Misses
                    </label>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Full 54-column export split into prospects.csv (no Bloomerang) and donors.csv (has Bloomerang). Shows consensus, founder, and member rows per group.
                    </div>
                </div>

                <!-- Multi-VA Property Report -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="exportMultiVAPropertyReport(parseInt(document.getElementById('multiVAMinCount').value) || 3)" style="padding: 8px 14px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; margin-right: 10px;">
                        üè† Multi-VA Property Report
                    </button>
                    <label style="display: inline-flex; align-items: center; font-size: 12px;">
                        Min VA members:
                        <input type="number" id="multiVAMinCount" value="3" min="2" max="20" style="width: 50px; margin-left: 5px; padding: 2px 4px;">
                    </label>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Groups with multiple VisionAppraisal entities (potential same-location issues). 54-column format, sorted by VA member count descending.
                    </div>
                </div>

                <!-- Simple Groups Export -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="exportEntityGroups()" style="padding: 8px 14px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üìÑ Simple Groups Export
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Quick 8-column export of currently filtered groups: index, name, address, member count, donor status, near miss count, phase, member keys.
                    </div>
                </div>

                <!-- Assessment Value Report -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="downloadAssessmentValueReport()" style="padding: 8px 14px; background: #00796b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üí∞ Assessment Value Report
                    </button>
                    <button onclick="verifyAssessmentChecksum()" style="padding: 8px 14px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; margin-left: 8px;">
                        ‚úì Verify Checksum
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Assessment report: total value per group, sorted descending. Includes subdivisions.<br>
                        Checksum: compares report total against raw VisionAppraisal data to verify no properties omitted.
                    </div>
                </div>

                <!-- Lightweight JSON Export (for Google Apps Script) -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="downloadLightweightExport(entityGroupBrowser.loadedDatabase)" style="padding: 8px 14px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üì¶ Lightweight JSON Export
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Self-contained JSON with reduced entity data embedded per group. For Google Apps Script consumption. Requires unified entity database loaded.
                    </div>
                </div>

                <!-- Prospect Mail Merge Export -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button id="prospectMailMergeBtn" onclick="runProspectMailMergeExport()" style="padding: 8px 14px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üì¨ Prospect Mail Merge
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        One row per group for mail merge. Loads EntityGroup database if needed. Excludes Bloomerang donors and excluded addresses.
                    </div>
                </div>

                <!-- Bloomerang Name Match Export -->
                <div>
                    <button id="bloomerangNameMatchBtn" onclick="runBloomerangLastNameMatchExport()" style="padding: 8px 14px; background: #7b1fa2; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üîç Bloomerang Name Match
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Find VA property owners matching Bloomerang-only group names. Shows * for VA entities already in groups.
                    </div>
                </div>
            </div>

            <!-- Entity Comparison Tool -->
            <div style="padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 15px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">Entity Comparison Tool</div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <input type="text" id="compareEntityKey1" placeholder="Entity 1 Key (e.g., visionAppraisal:FireNumber:1418)"
                           style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; font-family: monospace;">
                    <input type="text" id="compareEntityKey2" placeholder="Entity 2 Key (e.g., visionAppraisal:FireNumber:423)"
                           style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; font-family: monospace;">
                    <button onclick="runEntityComparison()"
                            style="padding: 8px 16px; background: #6c5ce7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        Compare Entities (output to console)
                    </button>
                </div>
                <div style="font-size: 11px; color: #6c757d; margin-top: 6px;">
                    Open browser DevTools (F12) to see comparison results
                </div>
            </div>

            <!-- Override Rules Audit -->
            <div style="padding: 12px; background: #fff3e0; border: 1px solid #ffcc80; border-radius: 6px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #e65100;">üîç Override Rules Audit</div>
                <button onclick="runOverrideRulesAudit()"
                        style="padding: 8px 16px; background: #ff6f00; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Audit Override Rules
                </button>
                <div style="font-size: 11px; color: #bf360c; margin-top: 6px;">
                    Verify FORCE_MATCH and FORCE_EXCLUDE rules were applied correctly to the EntityGroup database.
                    Loads rules from Google Sheets if needed. Outputs summary to console and downloads CSV with details.
                </div>
            </div>
        </div>

            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- DATABASE MAINTENANCE: Street Names and Fire Number Collisions              -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="phase-section db-maintenance collapsed" id="dbMaintenance">
            <div class="phase-header" onclick="togglePhase('dbMaintenance')">
                <span class="phase-toggle">‚ñº</span>
                <span class="phase-title">DATABASE MAINTENANCE: Alias and Collision Browsers</span>
                <span class="phase-subtitle">Street Name aliases, Fire Number collision tracking</span>
            </div>
            <div class="phase-content">

                <!-- Street Name Browser Section -->
                <div class="entity-browser-section" style="border-color: #00897b;">
                    <h3 style="color: #00897b;">Street Name Browser - Block Island Street Database Explorer</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">

                <!-- Load Controls Row -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button id="streetNameLoadBtn" class="action-button" style="background-color: #00897b; padding: 10px 20px; font-weight: 600;">
                            Load Street Database
                        </button>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>Street Name Browser:</strong> Browse, search, and manage Block Island street names.
                    Changes are saved automatically to Google Drive.
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <input type="text" id="streetNameSearchInput" class="search-input" placeholder="Search street names..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px;">
                <button id="streetNameSearchBtn" class="search-button" style="padding: 8px 16px; background: #00897b; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                <button id="streetNameClearBtn" class="search-button" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
                <button id="streetNameNewBtn" class="search-button" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ New Street</button>
            </div>

            <!-- Status Message -->
            <div id="streetNameStatusMessage" class="status-message" style="display: none;"></div>

            <!-- Main Content: Two-Panel Layout -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">

                <!-- Left Panel: Street List -->
                <div class="results-section" style="flex: 1; min-width: 350px;">
                    <div class="results-header">
                        <span id="streetNameResultsCount">Load street database to begin</span>
                    </div>
                    <div id="streetNameResultsList" class="results-list" style="max-height: 400px;">
                        <div style="padding: 20px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">&#127963;</div>
                            <div style="font-weight: 600; margin-bottom: 10px;">Street Name Browser</div>
                            <div>Load the street database to begin browsing</div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Details and Testing -->
                <div style="flex: 1; min-width: 400px;">

                    <!-- Selected Street Details -->
                    <div id="streetNameDetailsPanel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #00897b;">Selected Street</h4>
                        <div id="streetNameDetailsContent" style="color: #666;">
                            Select a street from the list to view details
                        </div>
                    </div>

                    <!-- compareTo Test Panel -->
                    <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">Test compareTo()</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="streetNameTestInput" placeholder="Enter street string to test..."
                                   style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button id="streetNameTestBtn" style="background: #1976d2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                Test
                            </button>
                        </div>
                        <div id="streetNameTestResult" style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px; min-height: 60px;">
                            Enter a string and press Enter or click Test to see compareTo() results
                        </div>
                    </div>

                    <!-- Add Alias Panel -->
                    <div style="background: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #ef6c00;">Add Alias to Selected Street</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <input type="text" id="streetNameAliasInput" placeholder="New alias string..."
                                   style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <select id="streetNameAliasCategory" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="homonyms">Homonym</option>
                                <option value="synonyms">Synonym</option>
                                <option value="candidates">Candidate</option>
                            </select>
                        </div>
                        <button id="streetNameAddAliasBtn" style="background: #ef6c00; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            + Add Alias
                        </button>
                        <div style="font-size: 11px; color: #666; margin-top: 8px;">
                            <strong>Homonym:</strong> Verified similar spelling |
                            <strong>Synonym:</strong> Unverified match |
                            <strong>Candidate:</strong> Verified contextual match
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="streetNameStatsBtn" class="action-button">Database Stats</button>
                <button id="streetNameExportBtn" class="action-button">Export JSON</button>
            </div>
        </div>

                <!-- Individual Name Browser Section -->
                <div class="entity-browser-section" style="border-color: #1565c0;">
                    <h3 style="color: #1565c0;">Individual Name Browser - Name Alias Database Explorer</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                <h4 style="margin: 0 0 15px 0; color: #1565c0;">Initializing Build</h4>

                <!-- Build/Resume Controls -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group">
                        <button id="individualNameBuildResumeBtn" class="action-button" style="background-color: #4caf50; padding: 10px 20px; font-weight: 600;">
                            Build Run/Resume
                        </button>
                    </div>
                    <div class="control-group">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Completed:</label>
                        <input type="text" id="individualNameCompletedCount" value="0" readonly
                               style="width: 80px; padding: 8px; text-align: center; background: #e8f5e9;">
                    </div>
                    <div class="control-group">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Remaining:</label>
                        <input type="text" id="individualNameRemainingCount" value="--" readonly
                               style="width: 80px; padding: 8px; text-align: center; background: #fff3e0;">
                    </div>
                    <div class="control-group">
                        <button id="individualNameResetBtn" class="action-button" style="background-color: #f44336; padding: 10px 20px; font-weight: 600;">
                            Reset
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="individualNameConsistencyCheckBtn" class="action-button" style="background-color: #2196f3; padding: 10px 20px; font-weight: 600;">
                            Constncy Chk
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="individualNameBackupBulkBtn" class="action-button" style="background-color: #4caf50; padding: 10px 20px; font-weight: 600;">
                            Backup Bulk
                        </button>
                    </div>
                </div>

                <!-- Folder ID Configuration -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="flex: 1; min-width: 300px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Objects Folder ID:</label>
                        <input type="text" id="individualNameFolderId" value="1XdIipdWlRy7VKlOJiCt_G706JWqZZY4m"
                               style="width: 100%; padding: 8px; font-family: monospace; font-size: 11px;">
                    </div>
                    <div class="control-group" style="flex: 1; min-width: 300px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Deleted Folder ID:</label>
                        <input type="text" id="individualNameDeletedFolderId" value="1Dk-hAeSEF96qsX-LoQyRZUHlYwOWKARt"
                               style="width: 100%; padding: 8px; font-family: monospace; font-size: 11px;">
                    </div>
                </div>

                <!-- Repopulate Window Button -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group">
                        <button id="individualNameLoadBtn" class="action-button" style="background-color: #607d8b; padding: 8px 16px; font-weight: 600;">
                            Repop. Window
                        </button>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>Individual Name Browser:</strong> Browse, search, and manage individual name aliases.
                    Built from EntityGroup consensus building. Changes are saved automatically to Google Drive.
                    <br><strong>Build Run/Resume:</strong> Processes up to 400 names per click to avoid Google Drive rate limits.
                    <br><strong>Repop. Window:</strong> Reload browser display from bulk database file.
                </div>
            </div>

            <!-- Incremental Change Controls -->
            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                <h4 style="margin: 0 0 15px 0; color: #1565c0;">Incremental Change</h4>

                <!-- Rebuild Bulk Controls -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group">
                        <button id="individualNameRebuildBulkBtn" class="action-button" style="background-color: #ff9800; padding: 10px 20px; font-weight: 600;">
                            Rebuild Bulk from Files
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="individualNameCrossCheckBtn" class="action-button" style="background-color: #9c27b0; padding: 10px 20px; font-weight: 600;">
                            Cross Check
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="individualNameRebuildMapBtn" class="action-button" style="background-color: #00897b; padding: 10px 20px; font-weight: 600;">
                            Rebuild Map
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="individualNameSyncDevToOriginalBtn" class="action-button" style="background-color: #2196f3; padding: 10px 20px; font-weight: 600;">
                            Sync DEV ‚Üí Original
                        </button>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>Purpose:</strong> Rebuild bulk file from Google Drive individual files.
                    <br>This is the reverse of Initializing Build - use when individual files have been modified and need to be consolidated back into the bulk database.
                    <br><strong>Note:</strong> Currently writes to DEV file for testing.
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <input type="text" id="individualNameSearchInput" class="search-input" placeholder="Search individual names..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px;">
                <button id="individualNameSearchBtn" class="search-button" style="padding: 8px 16px; background: #1565c0; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                <button id="individualNameClearBtn" class="search-button" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
                <button id="individualNameNewBtn" class="search-button" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ New Name</button>
            </div>

            <!-- Status Message -->
            <div id="individualNameStatusMessage" class="status-message" style="display: none;"></div>

            <!-- Main Content: Two-Panel Layout -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">

                <!-- Left Panel: Name List -->
                <div class="results-section" style="flex: 1; min-width: 350px;">
                    <div class="results-header">
                        <span id="individualNameResultsCount">Load individual name database to begin</span>
                    </div>
                    <div id="individualNameResultsList" class="results-list" style="max-height: 400px;">
                        <div style="padding: 20px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">&#128100;</div>
                            <div style="font-weight: 600; margin-bottom: 10px;">Individual Name Browser</div>
                            <div>Load the individual name database to begin browsing</div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Details and Testing -->
                <div style="flex: 1; min-width: 400px;">

                    <!-- Selected Name Details -->
                    <div id="individualNameDetailsPanel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">Selected Individual</h4>
                        <div id="individualNameDetailsContent" style="color: #666;">
                            Select a name from the list to view details
                        </div>
                    </div>

                    <!-- compareTo Test Panel -->
                    <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">Test compareTo()</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="individualNameTestInput" placeholder="Enter name to test..."
                                   style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button id="individualNameTestBtn" style="background: #1976d2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                Test
                            </button>
                        </div>
                        <div id="individualNameTestResult" style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px; min-height: 60px;">
                            Enter a name and press Enter or click Test to see compareTo() results
                        </div>
                    </div>

                    <!-- Add Alias Panel -->
                    <div style="background: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #ef6c00;">Add Alias to Selected Name</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <input type="text" id="individualNameAliasInput" placeholder="New alias string..."
                                   style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <select id="individualNameAliasCategory" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="homonyms">Homonym</option>
                                <option value="synonyms">Synonym</option>
                                <option value="candidates">Candidate</option>
                            </select>
                        </div>
                        <button id="individualNameAddAliasBtn" style="background: #ef6c00; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            + Add Alias
                        </button>
                        <div style="font-size: 11px; color: #666; margin-top: 8px;">
                            <strong>Homonym:</strong> High-similarity match |
                            <strong>Synonym:</strong> Medium-similarity match |
                            <strong>Candidate:</strong> Lower-similarity match
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="individualNameStatsBtn" class="action-button">Database Stats</button>
                <button id="individualNameExportBtn" class="action-button">Export JSON</button>
            </div>
        </div>

                <!-- Fire Number Collision Browser Section -->
                <div class="entity-browser-section" style="border-color: #1565c0;">
                    <h3 style="color: #1565c0;">Fire Number Collision Browser - PID/Fire Number Collision Tracker</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">

                <!-- File ID and Load Controls Row -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 320px;">
                        <label for="collisionDatabaseFileId" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Collision Database File ID:</label>
                        <input type="text" id="collisionDatabaseFileId" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; font-family: 'Courier New', monospace;"
                               value="1exdeASVuntM6b_nyJUNUO0_EqRX8Jjz0" placeholder="Enter file ID...">
                    </div>
                    <div class="control-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button id="collisionLoadBtn" class="action-button" style="background-color: #1565c0; padding: 10px 20px; font-weight: 600;">
                            Load Collision Database
                        </button>
                        <button id="collisionSaveBtn" class="action-button" style="background-color: #ff9800; padding: 10px 20px; font-weight: 600;">
                            Save Changes
                        </button>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>Fire Number Collision Browser:</strong> View and manage fire numbers where multiple PIDs exist at the same property.
                    Search by fire number or entity key. Manually add or remove entity keys from collision records.
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <input type="text" id="collisionSearchInput" class="search-input" placeholder="Search by fire number or entity key..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px;">
                <button id="collisionSearchBtn" class="search-button" style="padding: 8px 16px; background: #1565c0; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                <button id="collisionClearSearchBtn" class="search-button" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
                <button id="collisionNewRecordBtn" class="search-button" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ New Record</button>
            </div>

            <!-- Status Message -->
            <div id="collisionStatusMessage" class="status-message" style="display: none;"></div>

            <!-- Main Content: Two-Panel Layout -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">

                <!-- Left Panel: Collision List -->
                <div class="results-section" style="flex: 1; min-width: 350px;">
                    <div class="results-header">
                        <span id="collisionResultsCount">Load collision database to begin</span>
                    </div>
                    <div id="collisionResultsList" class="results-list" style="max-height: 400px;">
                        <div style="padding: 20px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">&#128293;</div>
                            <div style="font-weight: 600; margin-bottom: 10px;">Fire Number Collision Browser</div>
                            <div>Load the collision database to begin browsing</div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Details and Editing -->
                <div style="flex: 1; min-width: 400px;">

                    <!-- Selected Collision Details -->
                    <div id="collisionDetailsPanel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">Selected Collision</h4>
                        <div id="collisionDetailsContent" style="color: #666;">
                            Select a record from the list to view details
                        </div>
                    </div>

                    <!-- Edit Panel -->
                    <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">Edit Entity Keys</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <input type="text" id="collisionEntityKeyInput" placeholder="Entity key..."
                                   style="flex: 2; min-width: 200px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace; font-size: 11px;">
                            <input type="text" id="collisionPidInput" placeholder="PID (optional)"
                                   style="flex: 1; min-width: 80px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="collisionAddKeyBtn" style="background: #2e7d32; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                + Add Key
                            </button>
                            <button id="collisionRemoveKeyBtn" style="background: #c62828; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                - Remove Key
                            </button>
                            <button id="collisionDeleteRecordBtn" style="background: #757575; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                Delete Record
                            </button>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 8px;">
                            Enter an entity key (e.g., visionAppraisal:FireNumber:72A) to add or remove from the selected collision record.
                        </div>
                    </div>
                </div>
            </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="collisionStatsBtn" class="action-button">Database Stats</button>
                </div>
            </div>

            </div>
        </div>
    </div>
    <div id="ressieH">"dude"</div>
    <div id="streeter">"dude"</div>
    <p>first server</p>

    <!-- README Modal -->
    <div id="readmeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReadme()">&times;</span>
            <div id="readmeContent" class="readme-content">
                Loading README...
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/parse-address@latest/parse-address.min.js"></script>
    <script type="text/javascript" src="./scripts/googleLinks.js"></script>
    <script type="text/javascript" src="./scripts/fileLogistics.js"></script>
    <script type="text/javascript" src="./scripts/baseCode.js"></script>
    <script type="text/javascript" src="./scripts/oneToOneEntity.js"></script>
    <script type="text/javascript" src="./scripts/utils.js"></script>
    <script type="text/javascript" src="./scripts/core/visionAppraisalProcessing.js"></script>
    <script type="text/javascript" src="./scripts/core/googleDriveAPI.js"></script>
    <script type="text/javascript" src="./scripts/performance/optimizedProcessing.js"></script>
    <script type="text/javascript" src="./scripts/address/addressProcessing.js"></script>
    <script type="text/javascript" src="./scripts/testing/addressTesting.js"></script>
    <script type="text/javascript" src="./scripts/postProcessing.js"></script>
    <script type="text/javascript" src="./scripts/phonebook.js"></script>
    <script type="text/javascript" src="./scripts/phonebookParser.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/aliasClasses.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/contactInfo.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/householdInformation.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/entityClasses.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/entityGroup.js"></script>
    <script type="text/javascript" src="./scripts/utils/classSerializationUtils.js"></script>
    <script type="text/javascript" src="./scripts/databases/aliasedTermDatabase.js"></script>
    <script type="text/javascript" src="./scripts/databases/streetNameDatabase.js"></script>
    <script type="text/javascript" src="./scripts/databases/individualNameDatabase.js"></script>
    <script type="text/javascript" src="./scripts/visionAppraisalParser.js"></script>
    <script type="text/javascript" src="./scripts/dataSources/visionAppraisal.js"></script>
    <script type="text/javascript" src="./scripts/dataSources/processAllVisionAppraisalRecords.js"></script>
    <script type="text/javascript" src="./scripts/testAttributedTermSubclasses.js"></script>
    <script type="text/javascript" src="./scripts/bloomerang.js"></script>

    <!-- Unified Entity Browser System (dataSourceManager.js archived Dec 2025 - unused) -->
    <script type="text/javascript" src="./scripts/entityRenderer.js"></script>
    <script type="text/javascript" src="./scripts/matching/universalEntityMatcher.js"></script>
    <script type="text/javascript" src="./scripts/unifiedEntityBrowser.js"></script>

    <!-- Legacy browsers archived Dec 2025: entityBrowser.js, dataSourceManager.js, visionAppraisalBrowser.js -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // Phase section toggle functionality
        function togglePhase(phaseId) {
            const section = document.getElementById(phaseId);
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // Sync the two unified database file ID inputs
        document.addEventListener('DOMContentLoaded', function() {
            const inputA = document.getElementById('unifiedDatabaseFileId');
            const inputB = document.getElementById('unifiedDatabaseFileIdB');

            // Load saved value into both inputs
            const savedFileId = localStorage.getItem('birava_unifiedDatabaseFileId');
            if (savedFileId) {
                if (inputA) inputA.value = savedFileId;
                if (inputB) inputB.value = savedFileId;
            }

            // Sync inputs when either changes
            if (inputA) {
                inputA.addEventListener('change', function() {
                    if (inputB) inputB.value = this.value;
                });
            }
            if (inputB) {
                inputB.addEventListener('change', function() {
                    if (inputA) inputA.value = this.value;
                });
            }
        });

        // README Modal functionality - now loads CLAUDE.md
        async function showReadme() {
            const modal = document.getElementById('readmeModal');
            const content = document.getElementById('readmeContent');

            try {
                // Fetch CLAUDE.md from the server
                const response = await fetch('./CLAUDE.md');
                const readmeText = await response.text();

                // Convert markdown to HTML (basic conversion)
                const htmlContent = markdownToHtml(readmeText);
                content.innerHTML = htmlContent;

                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading CLAUDE.md:', error);
                content.innerHTML = '<h2>Error loading CLAUDE.md</h2><p>Could not load the CLAUDE.md file.</p>';
                modal.style.display = 'block';
            }
        }

        function closeReadme() {
            document.getElementById('readmeModal').style.display = 'none';
        }

        // Basic markdown to HTML converter
        function markdownToHtml(markdown) {
            return markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Code blocks
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                // Lists
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n/g, '<br>');
        }

        // processAndSaveVisionAppraisal() moved to scripts/ui/workflowHandlers.js

        // runEntityProcessing() moved to scripts/ui/workflowHandlers.js

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('readmeModal');
            if (event.target == modal) {
                closeReadme();
            }
        }

        // Unified Entity Browser key press handler
        function handleUnifiedSearchKeyPress(event) {
            if (event.key === 'Enter') {
                performUnifiedSearch();
            }
        }

        // Run full entity analysis with CSV download
        async function runFullEntityAnalysisWithCSV() {
            const btn = document.getElementById('analyzeAllEntitiesBtn');
            const originalText = btn.innerHTML;

            // Check if entities are loaded
            if (!window.workingLoadedEntities || window.workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            // Check if universalEntityMatcher is loaded
            if (typeof window.analyzeAllEntities !== 'function') {
                btn.innerHTML = '‚è≥ Loading matcher...';
                btn.disabled = true;

                try {
                    // Load the universal entity matcher script
                    const response = await fetch('./scripts/matching/universalEntityMatcher.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Universal Entity Matcher loaded');
                } catch (error) {
                    console.error('Failed to load universalEntityMatcher.js:', error);
                    alert('Failed to load the entity matcher script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Run the analysis
            btn.innerHTML = '‚è≥ Analyzing all entities...';
            btn.disabled = true;

            try {
                console.log('Starting full entity analysis...');
                const startTime = performance.now();

                // Run analyzeAllEntities with download enabled
                const results = analyzeAllEntities(null, { download: true, storeInMemory: true });

                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Analysis complete in ${elapsed}s`);
                console.log(`Results stored in window.lastAnalysisResults`);

                btn.innerHTML = '‚úÖ Analysis Complete!';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Entity analysis failed:', error);
                alert('Entity analysis failed.\n\nCheck console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Run chunked entity analysis (memory-safe)
        async function runChunkedEntityAnalysis() {
            const btn = document.getElementById('analyzeChunkedBtn');
            const originalText = btn.innerHTML;

            // Check if entities are loaded
            if (!window.workingLoadedEntities || window.workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            // Check if universalEntityMatcher is loaded
            if (typeof window.analyzeEntitiesChunked !== 'function') {
                btn.innerHTML = '‚è≥ Loading matcher...';
                btn.disabled = true;

                try {
                    // Load the universal entity matcher script
                    const response = await fetch('./scripts/matching/universalEntityMatcher.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Universal Entity Matcher loaded');
                } catch (error) {
                    console.error('Failed to load universalEntityMatcher.js:', error);
                    alert('Failed to load the entity matcher script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Run the chunked analysis
            btn.innerHTML = '‚è≥ Running chunked analysis...';
            btn.disabled = true;

            try {
                console.log('Starting chunked entity analysis...');
                const startTime = performance.now();

                // Run analyzeEntitiesChunked with specified options
                const results = await analyzeEntitiesChunked({
                    chunkSize: 100,
                    entityTypes: 'all',
                    limit: null,
                    startChunk: 0,
                    delayBetweenChunks: 200
                });

                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Chunked analysis complete in ${elapsed}s`);
                console.log(`Total chunks: ${results.totalChunks}, Total rows: ${results.totalRows}`);

                btn.innerHTML = '‚úÖ Chunked Analysis Complete!';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Chunked entity analysis failed:', error);
                alert('Chunked entity analysis failed.\n\nCheck console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Run entity analysis with direct upload to Google Drive (most memory-efficient)
        async function runGoogleDriveAnalysis() {
            const btn = document.getElementById('analyzeGoogleDriveBtn');
            const originalText = btn.innerHTML;

            // Check if entities are loaded
            if (!window.workingLoadedEntities || window.workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            // Check Google Drive authentication
            if (!gapi?.client?.getToken()?.access_token) {
                alert('Google Drive not authenticated!\n\nPlease sign in first using button 1 (Start Authentication).');
                return;
            }

            // Load the universalEntityMatcher first (contains getAllEntities and universalCompareTo)
            if (typeof window.universalCompareTo !== 'function' || typeof window.getAllEntities !== 'function') {
                btn.innerHTML = '‚è≥ Loading matcher...';
                btn.disabled = true;

                try {
                    const response = await fetch('./scripts/matching/universalEntityMatcher.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Universal Entity Matcher loaded');
                } catch (error) {
                    console.error('Failed to load universalEntityMatcher.js:', error);
                    alert('Failed to load the entity matcher script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Load the Google Drive analysis script
            if (typeof window.runEntityAnalysisToGoogleDrive !== 'function') {
                btn.innerHTML = '‚è≥ Loading Drive uploader...';

                try {
                    const response = await fetch('./scripts/matching/entityAnalysisToGoogleDrive.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Entity Analysis to Google Drive loaded');
                } catch (error) {
                    console.error('Failed to load entityAnalysisToGoogleDrive.js:', error);
                    alert('Failed to load the Google Drive analysis script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Prompt for start index (to allow resuming from where we left off)
            const startIndexInput = prompt(
                'Enter starting entity index:\n\n' +
                '‚Ä¢ Enter 0 (or leave blank) to start from the beginning\n' +
                '‚Ä¢ Enter a number to resume from that entity\n\n' +
                'Tip: Check console for "Processing entity X" to find where you left off.',
                '0'
            );

            if (startIndexInput === null) {
                // User cancelled
                return;
            }

            const startIndex = parseInt(startIndexInput, 10) || 0;

            // Run the analysis
            btn.innerHTML = '‚è≥ Analyzing & uploading...';
            btn.disabled = true;

            try {
                console.log(`Starting entity analysis with Google Drive upload from index ${startIndex}...`);

                const results = await runEntityAnalysisToGoogleDrive({
                    delayBetweenEntities: 50,
                    startIndex: startIndex
                });

                if (results) {
                    console.log(`‚úÖ Analysis complete!`);
                    console.log(`   Entities processed: ${results.entitiesProcessed}`);
                    console.log(`   Files created: ${results.filesCreated}`);
                    console.log(`   Errors: ${results.errors.length}`);
                    console.log(`   Total time: ${results.totalTime}s`);

                    btn.innerHTML = `‚úÖ Done! ${results.filesCreated} files`;

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 5000);
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }

            } catch (error) {
                console.error('Google Drive analysis failed:', error);
                alert('Google Drive analysis failed.\n\nCheck console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>

    <!-- Bloomerang Config File ID Management -->
    <script>
        // Load saved config file ID when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const savedFileId = localStorage.getItem('bloomerangConfigFileId');
            if (savedFileId) {
                document.getElementById('bloomerangConfigFileId').value = savedFileId;
            }
        });

        // Save config file ID to localStorage
        function saveBloomerangConfigFileId(fileId) {
            localStorage.setItem('bloomerangConfigFileId', fileId);
            console.log('‚úÖ Bloomerang config file ID saved:', fileId);
        }

        // Get current config file ID
        function getBloomerangConfigFileId() {
            const fileId = document.getElementById('bloomerangConfigFileId').value.trim();
            if (!fileId) {
                alert('Please enter a Bloomerang Config File ID');
                return null;
            }
            return fileId;
        }
    </script>

    <!-- Load All Entities Button Functionality -->
    <script src="./scripts/loadAllEntitiesButton.js"></script>

    <!-- Unified Database Persistence -->
    <script src="./scripts/unifiedDatabasePersistence.js"></script>

    <!-- Unified Database Source Splitter (for Google Apps Script compatibility) -->
    <script src="./scripts/unifiedDatabaseSourceSplitter.js"></script>

    <!-- Match Override Manager (must load before entityGroupBuilder) -->
    <script src="./scripts/matching/matchOverrideManager.js"></script>

    <!-- Entity Group Builder -->
    <script src="./scripts/matching/entityGroupBuilder.js"></script>

    <!-- EntityGroup Browser -->
    <script src="./scripts/entityGroupBrowser.js"></script>

    <!-- CSV Reports and Export Functions -->
    <script src="./scripts/export/csvReports.js"></script>

    <!-- Entity Comparison Diagnostic Tool -->
    <script src="./scripts/diagnostics/entityComparison.js"></script>

    <!-- Override Rules Audit Tool -->
    <script src="./scripts/diagnostics/auditOverrideRules.js"></script>

    <!-- Street Architecture Baseline Capture -->
    <script src="./scripts/diagnostics/streetArchitectureBaseline.js"></script>

    <!-- Street Type Abbreviation Manager -->
    <script src="./scripts/streetTypeAbbreviations.js"></script>

    <!-- StreetName Database Converter (Phase 2) -->
    <script src="./scripts/streetNameDatabaseConverter.js"></script>

    <!-- Street Name Browser -->
    <script src="./scripts/streetNameBrowser.js"></script>
    <script src="./scripts/databases/individualNameDatabaseBuilder.js"></script>
    <script src="./scripts/databases/individualNameDatabaseSaveManager.js"></script>
    <script src="./scripts/individualNameBrowser.js"></script>

    <!-- Fire Number Collision Database -->
    <script src="./scripts/fireNumberCollisionDatabase.js"></script>
    <script src="./scripts/fireNumberCollisionBrowser.js"></script>

    <!-- Lightweight EntityGroup Exporter (for Google Apps Script) -->
    <script src="./scripts/export/lightweightExporter.js"></script>

    <!-- Verification/Refresh utilities for PID data -->
    <script src="./verification.js"></script>

    <!-- Unified Database Button Handlers -->
    <!-- Helper functions (UNIFIED_DB_FILE_ID_KEY, saveUnifiedDatabaseFileId, getUnifiedDatabaseFileId) moved to scripts/ui/workflowHandlers.js -->
    <script>
        // Load saved file ID on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedFileId = localStorage.getItem(UNIFIED_DB_FILE_ID_KEY);
            if (savedFileId) {
                const input = document.getElementById('unifiedDatabaseFileId');
                if (input) {
                    input.value = savedFileId;
                }
            }

            // Initialize Fire Number Collision Browser
            if (typeof initializeFireNumberCollisionBrowser === 'function') {
                initializeFireNumberCollisionBrowser();
            }
        });

        // recordUnifiedDatabase() moved to scripts/ui/workflowHandlers.js

        // Load & Record Entities button handler
        async function loadAndRecordEntities() {
            const fileId = getUnifiedDatabaseFileId();
            if (!fileId) {
                alert('Please enter a Google Drive file ID for the unified database.');
                return;
            }

            const btn = document.getElementById('loadAndRecordBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Loading & Saving...';
            btn.disabled = true;

            try {
                const result = await loadSourcesAndSaveUnified(fileId);
                alert(`Entities loaded and unified database saved!\n\nEntities: ${result.saveResult.metadata.totalEntities}\nFile: ${result.saveResult.fileName}`);
            } catch (error) {
                console.error('Error in load & record:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // loadUnifiedDatabaseFromDrive() moved to scripts/ui/workflowHandlers.js

        // Split unified database into 3 files for Google Apps Script (50MB limit)
        async function splitDatabaseForAppsScript() {
            if (!window.unifiedEntityDatabase?.entities) {
                alert('Please load the Unified Database first (use "Load Unified Database" button).');
                return;
            }

            const entityCount = Object.keys(window.unifiedEntityDatabase.entities).length;
            if (!confirm(`Split ${entityCount} entities into 3 files for Google Apps Script?\n\nThis will create:\n- VisionAppraisal Part 1 (FireNumber < 800)\n- VisionAppraisal Part 2 (FireNumber >= 800)\n- Bloomerang\n\nEach file will be under 50MB.`)) {
                return;
            }

            const btn = document.getElementById('splitDbBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Splitting...';
            btn.disabled = true;

            try {
                const result = await splitUnifiedDatabaseThreeWay();

                const message = `Database split complete!\n\n` +
                    `VisionAppraisal Part 1:\n` +
                    `  File ID: ${result.visionAppraisal1.fileId}\n` +
                    `  Entities: ${result.visionAppraisal1.entityCount}\n` +
                    `  Size: ${result.visionAppraisal1.sizeMB} MB\n\n` +
                    `VisionAppraisal Part 2:\n` +
                    `  File ID: ${result.visionAppraisal2.fileId}\n` +
                    `  Entities: ${result.visionAppraisal2.entityCount}\n` +
                    `  Size: ${result.visionAppraisal2.sizeMB} MB\n\n` +
                    `Bloomerang:\n` +
                    `  File ID: ${result.bloomerang.fileId}\n` +
                    `  Entities: ${result.bloomerang.entityCount}\n` +
                    `  Size: ${result.bloomerang.sizeMB} MB\n\n` +
                    `Total: ${result.totalEntities} entities, ${result.totalSizeMB.toFixed(2)} MB\n\n` +
                    `File IDs saved to localStorage. Copy them to your Apps Script CONFIG.`;

                alert(message);
                console.log('Split database file IDs for Apps Script CONFIG:');
                console.log(`  VISION_APPRAISAL_1_FILE_ID: '${result.visionAppraisal1.fileId}'`);
                console.log(`  VISION_APPRAISAL_2_FILE_ID: '${result.visionAppraisal2.fileId}'`);
                console.log(`  BLOOMERANG_FILE_ID: '${result.bloomerang.fileId}'`);
            } catch (error) {
                console.error('Error splitting database:', error);
                alert('Error splitting database: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>

    <!-- External workflow handlers (extracted from inline scripts) -->
    <script src="scripts/ui/workflowHandlers.js"></script>

</body>
</html>
