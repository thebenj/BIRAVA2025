<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        /* Modal styles for README popup */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            height: 90%;
            overflow-y: auto;
            border-radius: 5px;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .readme-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin-top: 20px;
        }
        .readme-content h1 { color: #2c3e50; }
        .readme-content h2 { color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .readme-content h3 { color: #7f8c8d; }
        .readme-content code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
        .readme-content pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }

        /* Button organization styles */
        .button-section {
            border: 2px solid #3498db;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .button-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-family: Arial, sans-serif;
            font-size: 16px;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 5px;
        }
        .utility-buttons {
            margin-top: 20px;
        }
        .utility-buttons button {
            margin: 5px;
        }

        /* Entity Browser Styles */
        .entity-browser-section {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            padding: 20px;
        }

        .entity-browser-section h3 {
            color: #007bff;
            margin-top: 0;
        }

        .collection-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .collection-tab {
            padding: 10px 20px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .collection-tab.active {
            background-color: #007bff;
            color: white;
        }

        .search-section {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .search-input {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-button {
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .search-button:hover {
            background-color: #218838;
        }

        .quick-filters {
            margin-top: 10px;
        }

        .filter-button {
            padding: 5px 10px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }

        .filter-button:hover {
            background-color: #5a6268;
        }

        .results-section {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .results-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }

        .results-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .result-item:hover {
            background-color: #f8f9fa;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .entity-key {
            font-family: 'Courier New', monospace;
            color: #6c757d;
            font-size: 12px;
        }

        .entity-name {
            font-weight: bold;
            color: #333;
        }

        .entity-details {
            color: #666;
            font-size: 14px;
        }

        .action-buttons {
            margin-top: 15px;
        }

        .action-button {
            padding: 8px 16px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .action-button:hover {
            background-color: #138496;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .status-loading {
            background-color: #cce5ff;
            border: 1px solid #007bff;
            color: #004085;
        }

        .status-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        /* Unified Entity Browser Styles */
        .unified-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .unified-result-item:hover {
            background-color: #f8f9fa;
        }

        .unified-result-item.unified-selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .unified-result-item:last-child {
            border-bottom: none;
        }

        .unified-entity-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .unified-source-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .unified-source-visionappraisal {
            background-color: #dc3545;
        }

        .unified-source-bloomerang {
            background-color: #007bff;
        }

        .unified-entity-type {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .unified-entity-key {
            font-family: 'Courier New', monospace;
            color: #6c757d;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .unified-entity-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .unified-entity-details {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }

        .unified-status-message {
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .unified-status-loading {
            background-color: #cce5ff;
            border: 1px solid #007bff;
            color: #004085;
        }

        .unified-status-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .unified-status-success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .control-section {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .control-group label {
            font-size: 13px;
        }

        .control-group select {
            background-color: white;
            transition: border-color 0.2s ease;
        }

        .control-group select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        /* Responsive adjustments for unified browser */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 15px !important;
            }

            .control-group {
                min-width: auto !important;
            }

            .unified-entity-header {
                flex-wrap: wrap;
            }
        }

        /* EntityGroup Browser Styles */
        .entitygroup-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .entitygroup-result-item:hover {
            background-color: #f3e5f5;
        }

        .entitygroup-result-item.entitygroup-selected {
            background-color: #e1bee7;
            border-left: 4px solid #9c27b0;
        }

        .entitygroup-result-item:last-child {
            border-bottom: none;
        }

        .entitygroup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .entitygroup-index {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            background-color: #9c27b0;
        }

        .entitygroup-member-count {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .entitygroup-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .entitygroup-badge-prospect {
            background-color: #4caf50;
            color: white;
        }

        .entitygroup-badge-donor {
            background-color: #2196f3;
            color: white;
        }

        .entitygroup-badge-nearmiss {
            background-color: #ff9800;
            color: white;
        }

        .entitygroup-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .entitygroup-details {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }

        .entitygroup-members-preview {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="googleAuth">
        <button id="authorize_button" class="authBut myButts" onclick="handleAuthClick()">Authorize</button>
        <button id="signout_button" class="authBut myButts" onclick="handleSignoutClick()">Sign Out</button>
    </div>
    <div id="holder">
        <div class="button-section">
            <h3>VisionAppraisal Data Processing</h3>
            <button id="firstButton" class="optBut" onclick="firstButterClick()">First Button</button>
            <button id="secondButton" class="optBut" onclick="secondButterClick()">Second Button</button>
            <button id="thirdButton" class="optBut" onclick="thirdButterClick()">Third Button</button>
            <button id="fourthButton" class="optBut" onclick="fourthButterClick()">Fourth Button</button>
            <button id="analyzePids" class="optBut" onclick="analyzePIDFolder()" style="background-color: #6c757d; color: white;">Analyze PID Duplicates</button>
            <button id="cleanupPids" class="optBut" onclick="runPIDDeduplication()" style="background-color: #dc3545; color: white;">Run PID Deduplication</button>
            <button id="firstTwo" class="optBut" onclick="firstTwoClick()">First Two</button>
            <button id="firstThree" class="optBut" onclick="firstThreeClick()">First Three</button>
            <button id="AllButton" class="optBut" onclick="AllClick()">All Button</button>
            <button id="Go Again" class="optBut" onclick="goAgain()">Go Again</button>
            <button id="MandGo" class="optBut" onclick="mergeTheTwo()">Merge and Go Again</button>
            <button id="oneToONe" class="optBut" onclick="makeOneToOneFile()">Make One To One File</button>
            <button id="test" class="optBut" onclick="test()">Test</button>
        </div>

        <div class="button-section">
            <h3>Entity Reconstruction</h3>
            <div style="margin-bottom: 15px;">
                <label for="bloomerangConfigFileId" style="display: block; font-size: 12px; color: #333; margin-bottom: 5px;">
                    Bloomerang Config File ID (contains current entity file IDs):
                </label>
                <input type="text"
                       id="bloomerangConfigFileId"
                       placeholder="Enter Google Drive file ID"
                       style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;"
                       onchange="saveBloomerangConfigFileId(this.value)">
            </div>
            <button class="optBut" onclick="loadAllEntitiesIntoMemory()" style="background-color: #28a745; color: white;">
                üöÄ Load All Entities Into Memory
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                Loads all VisionAppraisal + Bloomerang entities from Google Drive into memory for analysis
            </p>

            <!-- Unified Database Persistence -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <label for="unifiedDatabaseFileId" style="display: block; font-size: 12px; color: #333; margin-bottom: 5px;">
                    Unified Database File ID (for persistence):
                </label>
                <input type="text"
                       id="unifiedDatabaseFileId"
                       placeholder="Enter Google Drive file ID for unified database"
                       style="width: 100%; padding: 8px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;"
                       onchange="saveUnifiedDatabaseFileId(this.value)">
            </div>
            <button class="optBut" onclick="recordUnifiedDatabase()" style="background-color: #3498db; color: white;" id="recordUnifiedBtn">
                üíæ Record Unified Database
            </button>
            <button class="optBut" onclick="loadAndRecordEntities()" style="background-color: #9b59b6; color: white;" id="loadAndRecordBtn">
                üì• Load & Record Entities
            </button>
            <button class="optBut" onclick="loadUnifiedDatabaseFromDrive()" style="background-color: #e67e22; color: white;" id="loadUnifiedBtn">
                üìÇ Load Unified Database
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                <strong>Record Unified Database:</strong> Saves in-memory entities to Google Drive.<br>
                <strong>Load & Record:</strong> Loads from source files (VA + Bloomerang) AND saves unified database.<br>
                <strong>Load Unified Database:</strong> Loads previously saved unified database from Google Drive (no regeneration).
            </p>
            <button class="optBut" onclick="splitDatabaseForAppsScript()" style="background-color: #27ae60; color: white;" id="splitDbBtn">
                ‚úÇÔ∏è Split Database for Apps Script
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                <strong>Split Database:</strong> Creates 3 files (VA Part 1, VA Part 2, Bloomerang) under 50MB each for Google Apps Script.
                Requires unified database loaded first. File IDs will be displayed in console and saved to localStorage.
            </p>
            <button class="optBut" onclick="runFullEntityAnalysisWithCSV()" style="background-color: #8e44ad; color: white;" id="analyzeAllEntitiesBtn">
                üìä Analyze All Entities & Download CSV
            </button>
            <button class="optBut" onclick="runChunkedEntityAnalysis()" style="background-color: #16a085; color: white;" id="analyzeChunkedBtn">
                üì¶ Chunked Analysis (Memory-Safe)
            </button>
            <button class="optBut" onclick="runGoogleDriveAnalysis()" style="background-color: #e74c3c; color: white;" id="analyzeGoogleDriveBtn">
                ‚òÅÔ∏è Analyze to Google Drive
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                <strong>Requires entities loaded first!</strong> Runs comparisons on all entity types (Individual, AggregateHousehold, Business, LegalConstruct) and downloads a CSV with one row per entity summarizing match results. <em>Chunked version</em> downloads in 200-entity batches to prevent browser memory issues. <em>Google Drive version</em> uploads each entity's matches directly to Google Drive (most memory-efficient).
            </p>
        </div>

        <div class="button-section">
            <h3>Other Data Sources</h3>
            <button class="optBut" onclick="readBloomerangWithEntities(true)">Process Bloomerang CSV</button>
            <button class="optBut" onclick="analyzeBloomerangCSV()">Analyze CSV Quality</button>
            <button class="optBut" onclick="readPhonebook()">Process Phonebook Data</button>
        </div>

        <div class="button-section">
            <h3>VisionAppraisal Data Processing</h3>
            <button class="optBut" onclick="generateFreshEveryThingWithPid()" id="refreshPidDataBtn" style="background-color: #17a2b8; color: white;">
                üì• Refresh Local PID Data from Google Drive
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                <strong>Step 0:</strong> Downloads all PID files from Google Drive folder and consolidates them into the local
                <code>everyThingWithPid.json</code> file. Run this after downloading new PIDs via Button 4 to update
                local data with latest assessment/appraisal values.
            </p>
            <button class="optBut" onclick="processAndSaveVisionAppraisal()" id="visionProcessBtn">
                üîÑ Process & Save VisionAppraisal Data
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                <strong>Step 1:</strong> Cleans name tags, parses MBLU fields,
                extracts addresses, and saves all 1,576 processed records to Google Drive
                (File ID: 1oIW1m1Qw2lyreU-uGMX3jUka9LwaBTAf).
                <br><strong>Use for matching:</strong> Creates processed dataset with
                <code>processedOwnerName</code>, parsed addresses, and enhanced fields.
            </p>
        </div>

        <div class="button-section">
            <h3>VisionAppraisal Entity Creation</h3>
            <div style="margin-bottom: 15px;">
                <label for="showDetailedResults" style="display: block; margin-bottom: 5px; font-weight: bold;">Show Detailed Results:</label>
                <select id="showDetailedResults" style="margin-bottom: 10px; padding: 5px;">
                    <option value="false">false - Normal output only</option>
                    <option value="true">true - Show detailed address processing by case</option>
                </select>
                <p style="font-size: 11px; color: #666; margin: 5px 0;">Controls whether to display detailed address processing information for each parser case.</p>

                <label for="quietMode" style="display: block; margin-bottom: 5px; font-weight: bold;">Quiet Mode:</label>
                <select id="quietMode" style="margin-bottom: 10px; padding: 5px;">
                    <option value="true">true - Suppress parser messages</option>
                    <option value="false">false - Show all parser output</option>
                </select>
                <p style="font-size: 11px; color: #666; margin: 5px 0;">Controls whether to suppress individual parser case messages during processing.</p>
            </div>

            <button class="optBut" onclick="runEntityProcessing()" id="entityProcessBtn">
                üèóÔ∏è Create Entities from Processed Data
            </button>
            <p style="font-size: 12px; color: #666; margin: 10px 0;">
                <strong>Step 2:</strong> Loads processed VisionAppraisal data and creates entity objects
                using the production parser. Saves 2,317 entities to Google Drive
                (File ID: 19cgccMYNBboL07CmMP-5hNNGwEUBXgCI).
                <br><strong>Prerequisites:</strong> Step 1 must complete first.
            </p>
        </div>

        <div class="utility-buttons">
            <button id="readmeButton" class="optBut" onclick="showReadme()">üìñ README</button>
        </div>

        <!-- Unified Entity Browser Section -->
        <div class="entity-browser-section" style="border-color: #28a745;">
            <h3 style="color: #28a745;">üåê Unified Entity Browser - Multi-Source Data Explorer</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                <div class="control-row" style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="unifiedDataSourceSelector" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Data Source:</label>
                        <select id="unifiedDataSourceSelector" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="all">üåê All Data Sources</option>
                            <option value="visionappraisal">üè† VisionAppraisal Property Data</option>
                            <option value="bloomerang">üë• Bloomerang Contact Database</option>
                        </select>
                    </div>

                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="unifiedEntityTypeSelector" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Entity Type:</label>
                        <select id="unifiedEntityTypeSelector" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="all">All Types</option>
                            <option value="Individual">Individual</option>
                            <option value="AggregateHousehold">Aggregate Household</option>
                            <option value="Business">Business</option>
                            <option value="LegalConstruct">Legal Construct</option>
                            <option value="NonHuman">Non-Human</option>
                        </select>
                    </div>

                    <div class="control-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button id="unifiedLoadDataBtn" class="action-button" style="background-color: #28a745; padding: 10px 20px; font-weight: 600;">
                            üìÅ Load All Data Sources
                        </button>
                        <button id="unifiedRefreshDisplayBtn" class="action-button" style="background-color: #17a2b8; padding: 10px 20px; font-weight: 600;" onclick="refreshUnifiedBrowserDisplay()">
                            üîÑ Refresh Display
                        </button>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>Multi-Source Browser:</strong> Select a specific data source or choose "All Data Sources" to browse entities from VisionAppraisal and Bloomerang simultaneously.
                    The browser will automatically adapt the display and filters based on your selection.
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="unifiedSearchInput" class="search-input" placeholder="Search across all fields: names, account numbers, fire numbers, addresses, emails..." onkeypress="handleUnifiedSearchKeyPress(event)">
                <button id="unifiedSearchBtn" class="search-button" onclick="performUnifiedSearch()">üîç Search</button>
                <button id="unifiedClearBtn" class="search-button" onclick="clearSearchAndFilters()" style="background-color: #6c757d;">Clear</button>

                <div class="quick-filters">
                    <strong>Enhanced Quick Filters:</strong>
                    <button class="filter-button" onclick="applyQuickFilter('account')">By Account #</button>
                    <button class="filter-button" onclick="applyQuickFilter('fire')">By Fire #</button>
                    <button class="filter-button" onclick="applyQuickFilter('pid')">By PID</button>
                    <button class="filter-button" onclick="applyQuickFilter('name')">By Name</button>
                    <button class="filter-button" onclick="applyQuickFilter('all')" style="background-color: #17a2b8;">Show All</button>
                </div>
            </div>

            <div id="unifiedStatusMessage" class="status-message" style="display: none;"></div>

            <div class="results-section">
                <div class="results-header">
                    <span id="unifiedResultsCount">Select data source and click Load to begin</span>
                </div>
                <div id="unifiedResultsList" class="results-list">
                    <div style="padding: 20px; text-align: center; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üåê</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Unified Entity Browser</div>
                        <div>Select data source and load data to begin browsing entities</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="unifiedViewDetailsBtn" class="action-button">üëÅÔ∏è View Details</button>
                <button id="unifiedAnalyzeMatchesBtn" class="action-button" style="background-color: #8e44ad;">üîç Analyze Matches</button>
                <button id="unifiedExportBtn" class="action-button" onclick="exportCurrentResults()">üìÑ Export Results</button>
                <button id="unifiedStatsBtn" class="action-button" onclick="showUnifiedStats()">üìä Unified Stats</button>
                <button class="action-button" onclick="clearSearchAndFilters()" style="background-color: #6c757d;">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <!-- EntityGroup Browser Section -->
        <div class="entity-browser-section" style="border-color: #9c27b0;">
            <h3 style="color: #9c27b0;">üìä EntityGroup Browser - Matched Entity Groups Explorer</h3>

            <div class="control-section" style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                <!-- File ID inputs row -->
                <div class="control-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 320px;">
                        <label for="entityGroupFileId" style="font-weight: 600; margin-bottom: 5px; color: #495057;">EntityGroup Database File ID:</label>
                        <input type="text" id="entityGroupFileId" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; font-family: 'Courier New', monospace;" placeholder="Enter database file ID...">
                    </div>
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 320px;">
                        <label for="entityGroupReferenceFileId" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Reference File ID:</label>
                        <input type="text" id="entityGroupReferenceFileId" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; font-family: 'Courier New', monospace;" placeholder="Enter reference file ID...">
                    </div>
                </div>

                <!-- Load/Build/Save buttons row -->
                <div class="control-row" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <button id="entityGroupLoadBtn" class="action-button" style="background-color: #9c27b0; padding: 10px 20px; font-weight: 600;">
                        üìÇ Load EntityGroups
                    </button>
                    <button id="entityGroupBuildBtn" class="action-button" style="background-color: #ff9800; padding: 10px 20px; font-weight: 600;">
                        üî® Build New
                    </button>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: #495057; cursor: pointer;">
                        <input type="checkbox" id="loadOverrideRulesCheckbox" checked style="cursor: pointer;">
                        Load override rules
                    </label>
                    <span style="color: #999; margin: 0 5px;">|</span>
                    <button id="entityGroupSaveToFileIdBtn" class="action-button" style="background-color: #17a2b8; padding: 10px 16px; font-weight: 600;">
                        üíæ Save to File IDs
                    </button>
                    <button id="entityGroupSaveAsNewBtn" class="action-button" style="background-color: #28a745; padding: 10px 16px; font-weight: 600;">
                        üìÑ Save as New Files
                    </button>
                </div>

                <div class="control-row" style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="entityGroupFilter" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Filter Groups:</label>
                        <select id="entityGroupFilter" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="all">All Groups</option>
                            <option value="multi">Multi-Member Only</option>
                            <option value="single">Single-Member Only</option>
                            <option value="prospects">Prospects (No Bloomerang)</option>
                            <option value="donors">Existing Donors (Has Bloomerang)</option>
                            <option value="nearMisses">Groups with Near Misses</option>
                        </select>
                    </div>
                    <div class="control-group" style="display: flex; flex-direction: column; min-width: 200px;">
                        <label for="entityGroupSort" style="font-weight: 600; margin-bottom: 5px; color: #495057;">Sort By:</label>
                        <select id="entityGroupSort" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <option value="index">Group Index</option>
                            <option value="memberCount">Member Count (Desc)</option>
                            <option value="name">Consensus Name</option>
                        </select>
                    </div>
                </div>

                <div class="info-text" style="font-size: 12px; color: #6c757d; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>EntityGroup Browser:</strong> Browse matched entity groups that consolidate entities from multiple data sources into unified real-world person/household representations.
                    Load a saved EntityGroup database from Google Drive or build a new one from the Unified Entity Database.
                </div>

                <!-- Load Unified Database button - Required to display entity names/addresses in the browser -->
                <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <button id="entityGroupLoadUnifiedDbBtn" class="action-button" style="background-color: #28a745; padding: 8px 16px; font-weight: 600;">
                            üìÇ Load Unified Database
                        </button>
                        <span style="font-size: 12px; color: #856404;">
                            <strong>Required:</strong> Load the Unified Entity Database to display founding member names and addresses.
                            Uses the file ID from "Entity Reconstruction" section above. Without this, groups will show "entity (not loaded)".
                        </span>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="entityGroupSearchInput" class="search-input" placeholder="Search groups by name, address, or member details...">
                <button id="entityGroupSearchBtn" class="search-button">üîç Search</button>
                <button id="entityGroupClearBtn" class="search-button" style="background-color: #6c757d;">Clear</button>
            </div>

            <div id="entityGroupStatusMessage" class="status-message" style="display: none;"></div>

            <div class="results-section">
                <div class="results-header">
                    <span id="entityGroupResultsCount">Enter file ID and click Load to browse EntityGroups</span>
                </div>
                <div id="entityGroupResultsList" class="results-list">
                    <div style="padding: 20px; text-align: center; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">EntityGroup Browser</div>
                        <div>Enter a Google Drive file ID and load to begin browsing entity groups</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="entityGroupViewDetailsBtn" class="action-button">üëÅÔ∏è View Group Details</button>
                <button id="entityGroupExportBtn" class="action-button">üìÑ Export Groups</button>
                <button id="entityGroupStatsBtn" class="action-button">üìä Group Stats</button>
            </div>
            <!-- CSV Reports Panel -->
            <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 6px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #2e7d32;">üì• CSV Reports</div>

                <!-- Prospects + Donors Export -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="downloadCSVExport()" style="padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; margin-right: 10px;">
                        üì• Prospects + Donors
                    </button>
                    <label style="display: inline-flex; align-items: center; font-size: 12px;">
                        <input type="checkbox" id="csvIncludeNearMisses" checked style="margin-right: 5px;">
                        Include Near Misses
                    </label>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Full 54-column export split into prospects.csv (no Bloomerang) and donors.csv (has Bloomerang). Shows consensus, founder, and member rows per group.
                    </div>
                </div>

                <!-- Multi-VA Property Report -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="exportMultiVAPropertyReport(parseInt(document.getElementById('multiVAMinCount').value) || 3)" style="padding: 8px 14px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; margin-right: 10px;">
                        üè† Multi-VA Property Report
                    </button>
                    <label style="display: inline-flex; align-items: center; font-size: 12px;">
                        Min VA members:
                        <input type="number" id="multiVAMinCount" value="3" min="2" max="20" style="width: 50px; margin-left: 5px; padding: 2px 4px;">
                    </label>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Groups with multiple VisionAppraisal entities (potential same-location issues). 54-column format, sorted by VA member count descending.
                    </div>
                </div>

                <!-- Simple Groups Export -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="exportEntityGroups()" style="padding: 8px 14px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üìÑ Simple Groups Export
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Quick 8-column export of currently filtered groups: index, name, address, member count, donor status, near miss count, phase, member keys.
                    </div>
                </div>

                <!-- Assessment Value Report -->
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9;">
                    <button onclick="downloadAssessmentValueReport()" style="padding: 8px 14px; background: #00796b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üí∞ Assessment Value Report
                    </button>
                    <button onclick="verifyAssessmentChecksum()" style="padding: 8px 14px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; margin-left: 8px;">
                        ‚úì Verify Checksum
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Assessment report: total value per group, sorted descending. Includes subdivisions.<br>
                        Checksum: compares report total against raw VisionAppraisal data to verify no properties omitted.
                    </div>
                </div>

                <!-- Lightweight JSON Export (for Google Apps Script) -->
                <div>
                    <button onclick="downloadLightweightExport(entityGroupBrowser.loadedDatabase)" style="padding: 8px 14px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        üì¶ Lightweight JSON Export
                    </button>
                    <div style="font-size: 11px; color: #558b2f; margin-top: 4px;">
                        Self-contained JSON with reduced entity data embedded per group. For Google Apps Script consumption. Requires unified entity database loaded.
                    </div>
                </div>
            </div>

            <!-- Entity Comparison Tool -->
            <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">Entity Comparison Tool</div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <input type="text" id="compareEntityKey1" placeholder="Entity 1 Key (e.g., visionAppraisal:FireNumber:1418)"
                           style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; font-family: monospace;">
                    <input type="text" id="compareEntityKey2" placeholder="Entity 2 Key (e.g., visionAppraisal:FireNumber:423)"
                           style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; font-family: monospace;">
                    <button onclick="runEntityComparison()"
                            style="padding: 8px 16px; background: #6c5ce7; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                        Compare Entities (output to console)
                    </button>
                </div>
                <div style="font-size: 11px; color: #6c757d; margin-top: 6px;">
                    Open browser DevTools (F12) to see comparison results
                </div>
            </div>
        </div>
    </div>
    <div id="ressieH">"dude"</div>
    <div id="streeter">"dude"</div>
    <p>first server</p>

    <!-- README Modal -->
    <div id="readmeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReadme()">&times;</span>
            <div id="readmeContent" class="readme-content">
                Loading README...
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/parse-address@latest/parse-address.min.js"></script>
    <script type="text/javascript" src="./scripts/googleLinks.js"></script>
    <script type="text/javascript" src="./scripts/fileLogistics.js"></script>
    <script type="text/javascript" src="./scripts/baseCode.js"></script>
    <script type="text/javascript" src="./scripts/oneToOneEntity.js"></script>
    <script type="text/javascript" src="./scripts/utils.js"></script>
    <script type="text/javascript" src="./scripts/core/visionAppraisalProcessing.js"></script>
    <script type="text/javascript" src="./scripts/core/googleDriveAPI.js"></script>
    <script type="text/javascript" src="./scripts/performance/optimizedProcessing.js"></script>
    <script type="text/javascript" src="./scripts/address/addressProcessing.js"></script>
    <script type="text/javascript" src="./scripts/testing/addressTesting.js"></script>
    <script type="text/javascript" src="./scripts/data/sampleDataLoader.js"></script>
    <script type="text/javascript" src="./scripts/postProcessing.js"></script>
    <script type="text/javascript" src="./scripts/phonebook.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/aliasClasses.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/contactInfo.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/householdInformation.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/entityClasses.js"></script>
    <script type="text/javascript" src="./scripts/objectStructure/entityGroup.js"></script>
    <script type="text/javascript" src="./scripts/utils/classSerializationUtils.js"></script>
    <script type="text/javascript" src="./scripts/visionAppraisalParser.js"></script>
    <script type="text/javascript" src="./scripts/dataSources/visionAppraisal.js"></script>
    <script type="text/javascript" src="./scripts/dataSources/processAllVisionAppraisalRecords.js"></script>
    <script type="text/javascript" src="./scripts/integration/matchingEngine.js"></script>
    <script type="text/javascript" src="./scripts/integration/contactDiscovery.js"></script>
    <script type="text/javascript" src="./scripts/integration/nameAnalysis.js"></script>
    <script type="text/javascript" src="./scripts/integration/testPlugin.js"></script>
    <script type="text/javascript" src="./scripts/testAttributedTermSubclasses.js"></script>
    <script type="text/javascript" src="./scripts/bloomerang.js"></script>

    <!-- Unified Entity Browser System -->
    <script type="text/javascript" src="./scripts/dataSourceManager.js"></script>
    <script type="text/javascript" src="./scripts/entityRenderer.js"></script>
    <script type="text/javascript" src="./scripts/matching/universalEntityMatcher.js"></script>
    <script type="text/javascript" src="./scripts/unifiedEntityBrowser.js"></script>

    <!-- Legacy Entity Browsers (kept for reference) -->
    <script type="text/javascript" src="./scripts/entityBrowser.js"></script>
    <script type="text/javascript" src="./scripts/visionAppraisalBrowser.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // README Modal functionality - now loads CLAUDE.md
        async function showReadme() {
            const modal = document.getElementById('readmeModal');
            const content = document.getElementById('readmeContent');

            try {
                // Fetch CLAUDE.md from the server
                const response = await fetch('./CLAUDE.md');
                const readmeText = await response.text();

                // Convert markdown to HTML (basic conversion)
                const htmlContent = markdownToHtml(readmeText);
                content.innerHTML = htmlContent;

                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading CLAUDE.md:', error);
                content.innerHTML = '<h2>Error loading CLAUDE.md</h2><p>Could not load the CLAUDE.md file.</p>';
                modal.style.display = 'block';
            }
        }

        function closeReadme() {
            document.getElementById('readmeModal').style.display = 'none';
        }

        // Basic markdown to HTML converter
        function markdownToHtml(markdown) {
            return markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Code blocks
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                // Lists
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n/g, '<br>');
        }

        // VisionAppraisal data processing function
        async function processAndSaveVisionAppraisal() {
            const btn = document.getElementById('visionProcessBtn');
            const originalText = btn.innerHTML;

            try {
                // Update button to show processing
                btn.innerHTML = '‚è≥ Processing VisionAppraisal Data...';
                btn.disabled = true;

                console.log("=== STARTING VISIONAPPRAISAL DATA PROCESSING ===");

                // Call the VisionAppraisal processing function
                const result = await VisionAppraisal.processAndSaveToGoogleDrive();

                if (result.success) {
                    console.log("‚úÖ VisionAppraisal processing completed successfully!");
                    console.log(`Records processed: ${result.recordCount}`);
                    console.log(`Google Drive File ID: ${result.fileId}`);

                    btn.innerHTML = '‚úÖ Processing Complete!';

                    // Show success message
                    alert(`VisionAppraisal data processing completed successfully!\n\n` +
                          `‚Ä¢ Records processed: ${result.recordCount}\n` +
                          `‚Ä¢ File saved to Google Drive\n` +
                          `‚Ä¢ File ID: ${result.fileId}\n` +
                          `‚Ä¢ Enhanced fields: processedOwnerName, parsed addresses, MBLU components\n\n` +
                          `The processed data is now ready for enhanced name matching!`);

                    // Reset button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 3000);

                } else {
                    throw new Error(result.error || 'Processing failed');
                }

            } catch (error) {
                console.error("‚ùå VisionAppraisal processing failed:", error);

                btn.innerHTML = '‚ùå Processing Failed';

                alert(`VisionAppraisal data processing failed:\n\n${error.message}\n\nCheck console for details.`);

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        // VisionAppraisal entity processing function
        async function runEntityProcessing() {
            const btn = document.getElementById('entityProcessBtn');
            const originalText = btn.innerHTML;

            try {
                // Get parameters from form inputs
                const showDetailedResults = document.getElementById('showDetailedResults').value === 'true';
                const quietMode = document.getElementById('quietMode').value === 'true';

                // Update button to show processing
                btn.innerHTML = '‚è≥ Creating Entities...';
                btn.disabled = true;

                console.log("=== STARTING VISIONAPPRAISAL ENTITY CREATION ===");
                console.log(`Parameters: showDetailedResults=${showDetailedResults}, quietMode=${quietMode}`);

                // Call the entity creation function with parameters
                const result = await processAllVisionAppraisalRecordsWithAddresses(showDetailedResults, quietMode);

                console.log("‚úÖ VisionAppraisal entity creation completed successfully!");
                btn.innerHTML = '‚úÖ Entity Creation Complete!';

                // Show success message
                alert(`VisionAppraisal entity creation completed successfully!\n\n` +
                      `‚Ä¢ Entities created from processed data\n` +
                      `‚Ä¢ Saved to Google Drive (File ID: 19cgccMYNBboL07CmMP-5hNNGwEUBXgCI)\n` +
                      `‚Ä¢ Parameters: Detailed Results = ${showDetailedResults}, Quiet Mode = ${quietMode}\n\n` +
                      `Entities are now ready for analysis and matching!`);

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error("‚ùå VisionAppraisal entity creation failed:", error);

                btn.innerHTML = '‚ùå Entity Creation Failed';

                alert(`VisionAppraisal entity creation failed:\n\n${error.message}\n\nCheck console for details.`);

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('readmeModal');
            if (event.target == modal) {
                closeReadme();
            }
        }

        // Unified Entity Browser key press handler
        function handleUnifiedSearchKeyPress(event) {
            if (event.key === 'Enter') {
                performUnifiedSearch();
            }
        }

        // Run full entity analysis with CSV download
        async function runFullEntityAnalysisWithCSV() {
            const btn = document.getElementById('analyzeAllEntitiesBtn');
            const originalText = btn.innerHTML;

            // Check if entities are loaded
            if (!window.workingLoadedEntities || window.workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            // Check if universalEntityMatcher is loaded
            if (typeof window.analyzeAllEntities !== 'function') {
                btn.innerHTML = '‚è≥ Loading matcher...';
                btn.disabled = true;

                try {
                    // Load the universal entity matcher script
                    const response = await fetch('./scripts/matching/universalEntityMatcher.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Universal Entity Matcher loaded');
                } catch (error) {
                    console.error('Failed to load universalEntityMatcher.js:', error);
                    alert('Failed to load the entity matcher script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Run the analysis
            btn.innerHTML = '‚è≥ Analyzing all entities...';
            btn.disabled = true;

            try {
                console.log('Starting full entity analysis...');
                const startTime = performance.now();

                // Run analyzeAllEntities with download enabled
                const results = analyzeAllEntities(null, { download: true, storeInMemory: true });

                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Analysis complete in ${elapsed}s`);
                console.log(`Results stored in window.lastAnalysisResults`);

                btn.innerHTML = '‚úÖ Analysis Complete!';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Entity analysis failed:', error);
                alert('Entity analysis failed.\n\nCheck console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Run chunked entity analysis (memory-safe)
        async function runChunkedEntityAnalysis() {
            const btn = document.getElementById('analyzeChunkedBtn');
            const originalText = btn.innerHTML;

            // Check if entities are loaded
            if (!window.workingLoadedEntities || window.workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            // Check if universalEntityMatcher is loaded
            if (typeof window.analyzeEntitiesChunked !== 'function') {
                btn.innerHTML = '‚è≥ Loading matcher...';
                btn.disabled = true;

                try {
                    // Load the universal entity matcher script
                    const response = await fetch('./scripts/matching/universalEntityMatcher.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Universal Entity Matcher loaded');
                } catch (error) {
                    console.error('Failed to load universalEntityMatcher.js:', error);
                    alert('Failed to load the entity matcher script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Run the chunked analysis
            btn.innerHTML = '‚è≥ Running chunked analysis...';
            btn.disabled = true;

            try {
                console.log('Starting chunked entity analysis...');
                const startTime = performance.now();

                // Run analyzeEntitiesChunked with specified options
                const results = await analyzeEntitiesChunked({
                    chunkSize: 100,
                    entityTypes: 'all',
                    limit: null,
                    startChunk: 0,
                    delayBetweenChunks: 200
                });

                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Chunked analysis complete in ${elapsed}s`);
                console.log(`Total chunks: ${results.totalChunks}, Total rows: ${results.totalRows}`);

                btn.innerHTML = '‚úÖ Chunked Analysis Complete!';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Chunked entity analysis failed:', error);
                alert('Chunked entity analysis failed.\n\nCheck console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Run entity analysis with direct upload to Google Drive (most memory-efficient)
        async function runGoogleDriveAnalysis() {
            const btn = document.getElementById('analyzeGoogleDriveBtn');
            const originalText = btn.innerHTML;

            // Check if entities are loaded
            if (!window.workingLoadedEntities || window.workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            // Check Google Drive authentication
            if (!gapi?.client?.getToken()?.access_token) {
                alert('Google Drive not authenticated!\n\nPlease sign in first using button 1 (Start Authentication).');
                return;
            }

            // Load the universalEntityMatcher first (contains getAllEntities and universalCompareTo)
            if (typeof window.universalCompareTo !== 'function' || typeof window.getAllEntities !== 'function') {
                btn.innerHTML = '‚è≥ Loading matcher...';
                btn.disabled = true;

                try {
                    const response = await fetch('./scripts/matching/universalEntityMatcher.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Universal Entity Matcher loaded');
                } catch (error) {
                    console.error('Failed to load universalEntityMatcher.js:', error);
                    alert('Failed to load the entity matcher script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Load the Google Drive analysis script
            if (typeof window.runEntityAnalysisToGoogleDrive !== 'function') {
                btn.innerHTML = '‚è≥ Loading Drive uploader...';

                try {
                    const response = await fetch('./scripts/matching/entityAnalysisToGoogleDrive.js');
                    const scriptText = await response.text();
                    eval(scriptText);
                    console.log('‚úÖ Entity Analysis to Google Drive loaded');
                } catch (error) {
                    console.error('Failed to load entityAnalysisToGoogleDrive.js:', error);
                    alert('Failed to load the Google Drive analysis script.\n\nCheck console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Prompt for start index (to allow resuming from where we left off)
            const startIndexInput = prompt(
                'Enter starting entity index:\n\n' +
                '‚Ä¢ Enter 0 (or leave blank) to start from the beginning\n' +
                '‚Ä¢ Enter a number to resume from that entity\n\n' +
                'Tip: Check console for "Processing entity X" to find where you left off.',
                '0'
            );

            if (startIndexInput === null) {
                // User cancelled
                return;
            }

            const startIndex = parseInt(startIndexInput, 10) || 0;

            // Run the analysis
            btn.innerHTML = '‚è≥ Analyzing & uploading...';
            btn.disabled = true;

            try {
                console.log(`Starting entity analysis with Google Drive upload from index ${startIndex}...`);

                const results = await runEntityAnalysisToGoogleDrive({
                    delayBetweenEntities: 50,
                    startIndex: startIndex
                });

                if (results) {
                    console.log(`‚úÖ Analysis complete!`);
                    console.log(`   Entities processed: ${results.entitiesProcessed}`);
                    console.log(`   Files created: ${results.filesCreated}`);
                    console.log(`   Errors: ${results.errors.length}`);
                    console.log(`   Total time: ${results.totalTime}s`);

                    btn.innerHTML = `‚úÖ Done! ${results.filesCreated} files`;

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 5000);
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }

            } catch (error) {
                console.error('Google Drive analysis failed:', error);
                alert('Google Drive analysis failed.\n\nCheck console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>

    <!-- Bloomerang Config File ID Management -->
    <script>
        // Load saved config file ID when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const savedFileId = localStorage.getItem('bloomerangConfigFileId');
            if (savedFileId) {
                document.getElementById('bloomerangConfigFileId').value = savedFileId;
            }
        });

        // Save config file ID to localStorage
        function saveBloomerangConfigFileId(fileId) {
            localStorage.setItem('bloomerangConfigFileId', fileId);
            console.log('‚úÖ Bloomerang config file ID saved:', fileId);
        }

        // Get current config file ID
        function getBloomerangConfigFileId() {
            const fileId = document.getElementById('bloomerangConfigFileId').value.trim();
            if (!fileId) {
                alert('Please enter a Bloomerang Config File ID');
                return null;
            }
            return fileId;
        }
    </script>

    <!-- Load All Entities Button Functionality -->
    <script src="./scripts/loadAllEntitiesButton.js"></script>

    <!-- Unified Database Persistence -->
    <script src="./scripts/unifiedDatabasePersistence.js"></script>

    <!-- Unified Database Source Splitter (for Google Apps Script compatibility) -->
    <script src="./scripts/unifiedDatabaseSourceSplitter.js"></script>

    <!-- Match Override Manager (must load before entityGroupBuilder) -->
    <script src="./scripts/matching/matchOverrideManager.js"></script>

    <!-- Entity Group Builder -->
    <script src="./scripts/matching/entityGroupBuilder.js"></script>

    <!-- EntityGroup Browser -->
    <script src="./scripts/entityGroupBrowser.js"></script>

    <!-- Lightweight EntityGroup Exporter (for Google Apps Script) -->
    <script src="./scripts/export/lightweightExporter.js"></script>

    <!-- Verification/Refresh utilities for PID data -->
    <script src="./verification.js"></script>

    <!-- Unified Database Button Handlers -->
    <script>
        // Storage key for unified database file ID
        const UNIFIED_DB_FILE_ID_KEY = 'birava_unifiedDatabaseFileId';

        // Save file ID to localStorage
        function saveUnifiedDatabaseFileId(fileId) {
            if (fileId && fileId.trim()) {
                localStorage.setItem(UNIFIED_DB_FILE_ID_KEY, fileId.trim());
                console.log('Unified database file ID saved:', fileId.trim());
            }
        }

        // Get file ID from localStorage or input
        function getUnifiedDatabaseFileId() {
            const input = document.getElementById('unifiedDatabaseFileId');
            if (input && input.value.trim()) {
                return input.value.trim();
            }
            return localStorage.getItem(UNIFIED_DB_FILE_ID_KEY);
        }

        // Load saved file ID on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedFileId = localStorage.getItem(UNIFIED_DB_FILE_ID_KEY);
            if (savedFileId) {
                const input = document.getElementById('unifiedDatabaseFileId');
                if (input) {
                    input.value = savedFileId;
                }
            }
        });

        // Record Unified Database button handler
        async function recordUnifiedDatabase() {
            const fileId = getUnifiedDatabaseFileId();
            if (!fileId) {
                alert('Please enter a Google Drive file ID for the unified database.');
                return;
            }

            if (!window.workingLoadedEntities || workingLoadedEntities.status !== 'loaded') {
                alert('Entities not loaded!\n\nPlease click "Load All Entities Into Memory" first.');
                return;
            }

            const btn = document.getElementById('recordUnifiedBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Saving...';
            btn.disabled = true;

            try {
                const result = await saveUnifiedDatabase(fileId);
                alert(`Unified database saved successfully!\n\nEntities: ${result.metadata.totalEntities}\nFile: ${result.fileName}`);
            } catch (error) {
                console.error('Error recording unified database:', error);
                alert('Error saving unified database: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Load & Record Entities button handler
        async function loadAndRecordEntities() {
            const fileId = getUnifiedDatabaseFileId();
            if (!fileId) {
                alert('Please enter a Google Drive file ID for the unified database.');
                return;
            }

            const btn = document.getElementById('loadAndRecordBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Loading & Saving...';
            btn.disabled = true;

            try {
                const result = await loadSourcesAndSaveUnified(fileId);
                alert(`Entities loaded and unified database saved!\n\nEntities: ${result.saveResult.metadata.totalEntities}\nFile: ${result.saveResult.fileName}`);
            } catch (error) {
                console.error('Error in load & record:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Load Unified Database from Google Drive (no regeneration)
        async function loadUnifiedDatabaseFromDrive() {
            const fileId = getUnifiedDatabaseFileId();
            if (!fileId) {
                alert('Please enter a Google Drive file ID for the unified database.');
                return;
            }

            const btn = document.getElementById('loadUnifiedBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Loading...';
            btn.disabled = true;

            try {
                // Clear any cached database from workingLoadedEntities path
                if (typeof clearEntityDatabaseCache === 'function') {
                    clearEntityDatabaseCache();
                }

                const result = await loadUnifiedDatabase(fileId);

                // Auto-populate the unified browser with loaded data
                if (typeof showAllEntities === 'function') {
                    showAllEntities();
                }

                const classStatus = result.classesRestored ? '‚úÖ Class types restored' : '‚ö†Ô∏è Class restoration issue';
                alert(`Unified database loaded from Google Drive!\n\n` +
                      `Entities: ${result.entityCount}\n` +
                      `Created: ${result.metadata.createdAt}\n` +
                      `${classStatus}`);
            } catch (error) {
                console.error('Error loading unified database:', error);
                alert('Error loading unified database: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Split unified database into 3 files for Google Apps Script (50MB limit)
        async function splitDatabaseForAppsScript() {
            if (!window.unifiedEntityDatabase?.entities) {
                alert('Please load the Unified Database first (use "Load Unified Database" button).');
                return;
            }

            const entityCount = Object.keys(window.unifiedEntityDatabase.entities).length;
            if (!confirm(`Split ${entityCount} entities into 3 files for Google Apps Script?\n\nThis will create:\n- VisionAppraisal Part 1 (FireNumber < 800)\n- VisionAppraisal Part 2 (FireNumber >= 800)\n- Bloomerang\n\nEach file will be under 50MB.`)) {
                return;
            }

            const btn = document.getElementById('splitDbBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Splitting...';
            btn.disabled = true;

            try {
                const result = await splitUnifiedDatabaseThreeWay();

                const message = `Database split complete!\n\n` +
                    `VisionAppraisal Part 1:\n` +
                    `  File ID: ${result.visionAppraisal1.fileId}\n` +
                    `  Entities: ${result.visionAppraisal1.entityCount}\n` +
                    `  Size: ${result.visionAppraisal1.sizeMB} MB\n\n` +
                    `VisionAppraisal Part 2:\n` +
                    `  File ID: ${result.visionAppraisal2.fileId}\n` +
                    `  Entities: ${result.visionAppraisal2.entityCount}\n` +
                    `  Size: ${result.visionAppraisal2.sizeMB} MB\n\n` +
                    `Bloomerang:\n` +
                    `  File ID: ${result.bloomerang.fileId}\n` +
                    `  Entities: ${result.bloomerang.entityCount}\n` +
                    `  Size: ${result.bloomerang.sizeMB} MB\n\n` +
                    `Total: ${result.totalEntities} entities, ${result.totalSizeMB.toFixed(2)} MB\n\n` +
                    `File IDs saved to localStorage. Copy them to your Apps Script CONFIG.`;

                alert(message);
                console.log('Split database file IDs for Apps Script CONFIG:');
                console.log(`  VISION_APPRAISAL_1_FILE_ID: '${result.visionAppraisal1.fileId}'`);
                console.log(`  VISION_APPRAISAL_2_FILE_ID: '${result.visionAppraisal2.fileId}'`);
                console.log(`  BLOOMERANG_FILE_ID: '${result.bloomerang.fileId}'`);
            } catch (error) {
                console.error('Error splitting database:', error);
                alert('Error splitting database: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>

</body>
</html>
